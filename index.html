<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Prospects proches ‚Äì v1.3.5</title>
  <style>
    :root{--bg:#0f141b;--panel:#152033;--card:#0f192d;--muted:#9db2ce;--text:#eaf2ff;--accent:#6558ff;--accent2:#7a6dff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .title{font-weight:800;font-size:22px;margin:0}
    .pill{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:6px 10px;font-size:13px}
    .city{color:var(--muted);margin:0 0 18px}
    .card{background:var(--panel);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .text{flex:1;min-width:160px;padding:10px 12px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:var(--text)}
    select{padding:10px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:var(--text)}
    .btn{background:#1b2844;color:var(--text);border:1px solid #223456;border-radius:12px;padding:11px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:var(--accent);border-color:var(--accent2);font-weight:700}
    .results{margin-top:12px}
    .item{background:var(--card);border:1px solid #203050;border-radius:12px;padding:12px;margin-top:10px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;background:#1b2844;border:1px solid #223456;border-radius:999px;padding:2px 8px;font-size:12px;color:#cfe1ff;margin-right:4px}
    .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .8s linear infinite;margin-right:8px;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .chip{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:7px 12px;cursor:pointer;font-size:14px;user-select:none}
    .chip.active{background:var(--accent);border-color:var(--accent2);color:#fff}
      /* Auth overlay */
    .overlay{position:fixed;inset:0;background:rgba(5,10,20,.85);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .panel{background:#0f192d;border:1px solid #203050;border-radius:16px;max-width:420px;width:100%;padding:18px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 class="title">Prospects proches <span style="font-size:14px;color:#9db2ce">v1.3.5</span></h1>
    <div id="authStatus" class="pill">Non connect√©</div>
  </div>
  <div class="city">Ville : <span id="city">‚Äî</span></div>

  <div class="card">
    <div class="row">
      <button id="btnGeoloc" class="btn">üìç Me g√©olocaliser</button>
      <button id="btnManual" class="btn" title="Entrer ma position manuellement">‚úçÔ∏è Entrer ma position</button>
      <input id="lat" class="text" placeholder="lat" style="display:none;width:140px">
      <input id="lon" class="text" placeholder="lon" style="display:none;width:160px">
      <button id="btnUseManual" class="btn" style="display:none">‚úÖ Utiliser cette position</button>
      <select id="radius">
        <option value="3000">3 km</option>
        <option value="5000">5 km</option>
        <option value="10000" selected>10 km</option>
        <option value="20000">20 km</option>
      </select>
      <input id="keyword" class="text" placeholder="Mot‚Äëcl√© (ex: plombier)" />
      <label style="display:flex;gap:6px;align-items:center"><input id="onlyOpen" type="checkbox"/> Uniquement ouverts</label>
      <select id="limit" title="Nombre max de r√©sultats">
        <option value="3">3</option>
        <option value="5" selected>5</option>
        <option value="10">10</option>
      </select>
      <button id="btnSearch" class="btn btn-primary" style="margin-left:auto">üîé Chercher</button>
      <button id="btnLogout" class="btn" style="display:none">üö™ D√©connexion</button>
    </div>

    <div class="chips" id="chips">
      <div class="chip active" data-cat="all">Tous</div>
      <div class="chip" data-cat="enr">ENR</div>
      <div class="chip" data-cat="depannage">D√©pannage chaudi√®re</div>
      <div class="chip" data-cat="sanitaire">Sanitaire</div>
      <div class="chip" data-cat="chauffagiste">Chauffagiste</div>
    </div>

    <div id="results" class="results muted">(R√©sultats ici une fois connect√©)</div>
  </div>
</div>

<!-- Auth overlay -->
<div id="authOverlay" class="overlay">
  <div class="panel">
    <h3>Connexion requise</h3>
    <div class="row"><input id="email" class="text" type="email" placeholder="E‚Äëmail" autocomplete="username"></div>
    <div class="row"><input id="password" class="text" type="password" placeholder="Mot de passe (‚â• 8)" autocomplete="current-password"></div>
    <div class="row">
      <button id="btnLogin" class="btn btn-primary">Se connecter</button>
      <button id="btnSignup" class="btn" style="display:none">Cr√©er mon compte</button>
    </div>
    <div id="authMsg" class="muted"></div>
  </div>
</div>

<script>
const WORKER_URL = "https://restless-heart-0d76.thiery-dimitri-pro.workers.dev";
const $ = (id)=>document.getElementById(id);
const ui = {city: $('city'), res:$('results'), btnGeo:$('btnGeoloc'), btnManual:$('btnManual'), lat:$('lat'), lon:$('lon'), use:$('btnUseManual'), radius:$('radius'), kw:$('keyword'), only:$('onlyOpen'), limit:$('limit'), search:$('btnSearch'), logout:$('btnLogout'), chips:$('chips'), overlay:$('authOverlay'), email:$('email'), pass:$('password'), login:$('btnLogin'), signup:$('btnSignup'), msg:$('authMsg'), status:$('authStatus')};
let state = {lat:null, lon:null, authed:false, me:null};

// ---- AUTH ----
function setOverlay(v){ ui.overlay.style.display = v?'flex':'none'; }
function toast(t){ ui.msg.textContent = t; }
async function api(path, opt={}){
  const res = await fetch(WORKER_URL+path,{method:opt.method||'GET', headers:{'content-type':'application/json'}, credentials:'include', body: opt.body?JSON.stringify(opt.body):undefined});
  if(res.status===401) throw new Error('401');
  const j = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(j.error||res.statusText); return j;
}
async function checkAuth(){
  try{ const me = await api('/auth/me'); state.authed=true; state.me=me; ui.status.textContent='Connect√©: '+(me.email||''); ui.logout.style.display=''; setOverlay(false); ui.res.textContent=''; }
  catch(_){ state.authed=false; ui.status.textContent='Non connect√©'; ui.logout.style.display='none'; setOverlay(true); }
}
ui.login.onclick = async()=>{ try{ await api('/auth/login',{method:'POST',body:{email:ui.email.value.trim(),password:ui.pass.value}}); toast('Connect√© ‚úî'); await checkAuth(); }catch(e){ toast(e.message==='401'?'Identifiants invalides':'Erreur: '+e.message);} };
ui.logout.onclick = async()=>{ try{ await api('/auth/logout',{method:'POST'}); }catch(_){ } await checkAuth(); };

// --- GEO auto (restaur√©)
ui.btnGeo.onclick = ()=>{
  if(!state.authed) return setOverlay(true);
  ui.city.textContent='Localisation‚Ä¶';
  navigator.geolocation.getCurrentPosition(async(pos)=>{
    state.lat=pos.coords.latitude; state.lon=pos.coords.longitude;
    try{
      const g=await api(`/geocode?lat=${state.lat}&lon=${state.lon}`);
      const city=(g?.results?.[0]?.address_components||[])
        .find(c=>c.types.includes('locality'))?.long_name
        || g?.results?.[0]?.formatted_address || '‚Äî';
      ui.city.textContent=city;
    }catch{ ui.city.textContent='‚Äî'; }
  },()=>{
    ui.city.textContent='‚Äî';
    alert('G√©olocalisation refus√©e ou indisponible. Utilise "Entrer ma position".');
    ui.btnManual.click();
  },{enableHighAccuracy:true,timeout:10000});
};

// --- GEO manuelle (restaur√©)
ui.btnManual.onclick = ()=>{
  ui.lat.style.display=ui.lon.style.display=ui.use.style.display='';
  ui.lat.focus();
};
ui.use.onclick = async ()=>{
  const lat=parseFloat((ui.lat.value||'').replace(',','.'));
  const lon=parseFloat((ui.lon.value||'').replace(',','.'));
  if(Number.isFinite(lat)&&Number.isFinite(lon)){
    state.lat=lat; state.lon=lon;
    try{
      const g=await api(`/geocode?lat=${lat}&lon=${lon}`);
      ui.city.textContent=g?.results?.[0]?.formatted_address||'‚Äî';
    }catch{ ui.city.textContent='‚Äî'; }
  }else{
    alert('Coordonn√©es invalides');
  }
};

// ---- Chips ----
ui.chips.addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  const code = chip.dataset.cat;
  if(code === 'all'){
    ui.chips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
  }else{
    chip.classList.toggle('active');
    const anyCat = Array.from(ui.chips.querySelectorAll('.chip.active')).some(c=>c.dataset.cat!=='all');
    const allChip = ui.chips.querySelector('[data-cat="all"]');
    if(anyCat) allChip.classList.remove('active');
    if(!anyCat) allChip.classList.add('active');
  }
});

// ---- Cat√©gories ----
const CAT_QUERY = {
  sanitaire: ['plombier','plomberie','d√©pannage plomberie','salle de bain','sanitaire'],
  depannage: ['d√©pannage chaudi√®re','entretien chaudi√®re','r√©paration chaudi√®re'],
  chauffagiste: ['chauffagiste','pose chaudi√®re','installation chauffage'],
  enr: ['pompe √† chaleur','climatisation','chauffage r√©versible','ENR']
};

// ---- Recherche ----
ui.search.onclick = async()=>{
  if(!state.authed) return setOverlay(true);
  if(!state.lat||!state.lon) return alert('D√©finis ta position.');
  ui.res.innerHTML='<span class="spinner"></span> Recherche en cours‚Ä¶';

  const manualKw = (ui.kw.value||'').trim();
  const limit = parseInt(ui.limit.value||'5',10);
  const activeCats = Array.from(ui.chips.querySelectorAll('.chip.active')).map(c=>c.dataset.cat).filter(c=>c!=='all');

  try{
    if(manualKw){
      const results = (await fetchNearby(manualKw)).slice(0, limit);
      showResults(results,[`Mot-cl√©: \"${manualKw}\"`]);
      ui.kw.value='';
      return;
    }

    if(!activeCats.length){
      const results = (await fetchNearby('plombier')).slice(0, limit);
      showResults(results,['Tous']);
      return;
    }

    const merged = new Map();
    for(const cat of activeCats){
      for(const term of (CAT_QUERY[cat]||[])){
        const res = await fetchNearby(term);
        for(const r of res){ if(!merged.has(r.place_id)) merged.set(r.place_id,r); }
        if(merged.size >= limit) break;
      }
      if(merged.size >= limit) break;
    }
    const results = Array.from(merged.values()).slice(0, limit);
    showResults(results, activeCats.map(code=>{
      return code==='enr'?'ENR': code==='depannage'?'D√©pannage chaudi√®re': code==='sanitaire'?'Sanitaire': code==='chauffagiste'?'Chauffagiste': code;
    }));

  }catch(e){ ui.res.textContent = 'Erreur: '+e.message; }
};

async function fetchNearby(keyword){
  const url = new URL(WORKER_URL+'/nearby');
  url.searchParams.set('lat',state.lat);
  url.searchParams.set('lon',state.lon);
  url.searchParams.set('radius',ui.radius.value);
  url.searchParams.set('keyword',keyword);
  if(ui.only.checked) url.searchParams.set('opennow','true');
  const data = await fetch(url,{credentials:'include'}).then(r=>r.json());
  return data?.results||[];
}

function showResults(items, badges){
  if(!items.length){ ui.res.textContent='Aucun r√©sultat.'; return; }
  ui.res.innerHTML = items.map(r=>{
    const name=r.name||'‚Äî';
    const addr=r.vicinity||r.formatted_address||'';
    const open=r.opening_hours?.open_now;
    const badgeOpen=open===true?'üü¢ Ouvert':(open===false?'üî¥ Ferm√©':'‚ö™ Horaires ?');
    const badgeHtml = (badges||[]).map(b=>`<span class=\"badge\">${b}</span>`).join('');
    const mapPayload = JSON.stringify({name,addr,lat:r.geometry?.location?.lat,lon:r.geometry?.location?.lng,place_id:r.place_id});
    return `<div class=\"item\">\n      <div style=\"display:flex;justify-content:space-between;gap:8px;align-items:flex-start;flex-wrap:wrap\">\n        <div>\n          <div style=\"font-weight:700\">${name} ${badgeHtml}</div>\n          <div class=\"muted\" style=\"margin:4px 0\">${badgeOpen}</div>\n          <div class=\"muted\">üìç ${addr||'‚Äî'}</div>\n        </div>\n        <div style=\"display:flex;gap:8px;align-items:center\">\n          <button class=\"btn\" onclick='openMaps(${mapPayload})'>üó∫Ô∏è Maps</button>\n          <button class=\"btn\" onclick='showDetails(\"${r.place_id}\")'>‚ÑπÔ∏è Infos</button>\n        </div>\n      </div>\n      <div class=\"muted\" id=\"d_${r.place_id}\" style=\"margin-top:6px\"></div>\n    </div>`;
  }).join('');
}

// Maps + d√©tails inchang√©s
window.openMaps = ({name,addr,lat,lon,place_id})=>{
  const label=name||addr||''; let url='';
  if(place_id) url=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(label)}&query_place_id=${encodeURIComponent(place_id)}`;
  else if(lat&&lon) url=`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
  else url=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(label)}`;
  window.open(url,'_blank','noopener');
};
window.showDetails = async (place_id)=>{
  const box=document.getElementById('d_'+place_id); if(!box) return; box.textContent='Chargement‚Ä¶';
  try{ const j=await fetch(WORKER_URL+`/details?place_id=${place_id}`,{credentials:'include'}).then(r=>r.json()); const res=j.result||{}; const tel=res.formatted_phone_number||res.international_phone_number||''; const web=res.website||res.url||''; const telHref=(tel||'').replace(/\s/g,''); box.innerHTML=[tel?`‚òéÔ∏è <a href=\"tel:${telHref}\">${tel}</a>`:'', web?`üåê <a href=\"${web}\" target=\"_blank\">Site</a>`:''].filter(Boolean).join(' ¬∑ ') || 'Aucune info.'; }
  catch(_){ box.textContent='Erreur.'; }
};

checkAuth();
</script>
</body>
</html>
