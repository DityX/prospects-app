<!--
Prospects proches ‚Äì Patch 1.3.0 (Auth MVP)
Base: 1.2.2
Ajouts: Authentification e‚Äëmail/mot de passe (signup/login/logout) via Worker + JWT HttpOnly
-->
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prospects proches</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6558ff">
<style>
  body{margin:0;background:#0f141b;color:#eaf2ff;font:16px/1.4 system-ui}
  .wrap{max-width:880px;margin:32px auto;padding:0 16px}
  .title{font-weight:700;font-size:22px;margin:0 0 6px}
  .city{color:#9db2ce;margin:0 0 18px}
  .card{background:#152033;border-radius:16px;padding:14px 14px 18px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
  .btn{background:#1b2844;color:#eaf2ff;border:1px solid #223456;border-radius:12px;padding:12px 14px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-primary{background:#6558ff;border-color:#7a6dff;font-weight:600;flex:1}
  select,input[type="checkbox"]{accent-color:#6558ff}
  select{padding:10px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:#eaf2ff;flex:1}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 6px}
  .chip{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .chip.active{background:#6558ff;border-color:#7a6dff;color:#fff}
  .results{margin-top:14px}
  .item{background:#0f192d;border:1px solid #203050;border-radius:12px;padding:12px;margin-top:10px}
  .item a{color:#cfe1ff;text-decoration:none}
  .badge{font-size:12px;opacity:.85}
  .meta{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0}
  .row-slim{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .legend{margin-top:14px;font-size:14px;color:#9db2ce}
  .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .8s linear infinite;margin-right:8px;vertical-align:-3px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .text{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:#eaf2ff}
  /* Auth overlay */
  .overlay{position:fixed;inset:0;background:rgba(5,10,20,.8);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .panel{background:#0f192d;border:1px solid #203050;border-radius:16px;max-width:420px;width:100%;padding:18px}
  .panel h2{margin:0 0 12px;font-size:18px}
  .muted{color:#9db2ce;font-size:14px;margin-top:8px}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  .pill{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:6px 10px;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 class="title">Prospects proches</h1>
    <div id="authStatus" class="pill">Non connect√©</div>
  </div>
  <div class="city">Ville : <span id="city">‚Äî</span></div>

  <div class="card">
    <!-- ... tes filtres et boutons existants (inchang√©s) ... -->
    <div class="row">
      <button id="btnGeoloc" class="btn">üìç Me g√©olocaliser</button>
      <button id="btnSearch" class="btn btn-primary">üîé Chercher</button>
      <button id="btnLogout" class="btn" style="margin-left:auto;display:none">üö™ D√©connexion</button>
    </div>
    <div id="results" class="results"></div>
    <div class="legend">üü¢ = Ouvert &nbsp; | &nbsp; üî¥ = Ferm√© &nbsp; | &nbsp; ‚ö™ = Horaires non renseign√©s</div>
  </div>
</div>

<!-- Auth overlay -->
<div id="authOverlay" class="overlay">
  <div class="panel">
    <h2>Connexion requise</h2>
    <div class="row"><input id="email" class="text" type="email" placeholder="E‚Äëmail" autocomplete="username"></div>
    <div class="row"><input id="password" class="text" type="password" placeholder="Mot de passe" autocomplete="current-password"></div>
    <div class="row">
      <button id="btnLogin" class="btn btn-primary">Se connecter</button>
      <button id="btnSignup" class="btn">Cr√©er mon compte</button>
    </div>
    <div id="authMsg" class="muted"></div>
  </div>
</div>

<script>
const WORKER_URL = "https://restless-heart-0d76.thiery-dimitri-pro.workers.dev"; // inchang√©
const els = {
  btnSearch: document.getElementById('btnSearch'),
  btnGeoloc: document.getElementById('btnGeoloc'),
  btnLogout: document.getElementById('btnLogout'),
  results: document.getElementById('results'),
  city: document.getElementById('city'),
  overlay: document.getElementById('authOverlay'),
  email: document.getElementById('email'),
  password: document.getElementById('password'),
  btnLogin: document.getElementById('btnLogin'),
  btnSignup: document.getElementById('btnSignup'),
  authMsg: document.getElementById('authMsg'),
  authStatus: document.getElementById('authStatus'),
};

let state = {lat:null, lon:null, city:null, results:[], authed:false, me:null};

function toast(msg){
  els.authMsg.textContent = msg;
}
function setOverlay(on){ els.overlay.style.display = on ? 'flex' : 'none'; }

async function api(path, opts={}){
  const res = await fetch(WORKER_URL + path, {
    method: opts.method || 'GET',
    headers: {'content-type':'application/json'},
    credentials: 'include', // IMPORTANT pour cookie HttpOnly
    body: opts.body ? JSON.stringify(opts.body) : undefined,
  });
  const data = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(data.error || res.statusText);
  return data;
}

async function checkAuth(){
  try{
    const me = await api('/auth/me');
    state.authed = true; state.me = me;
    els.authStatus.textContent = 'Connect√©: ' + (me.email || '');
    els.btnLogout.style.display = '';
    setOverlay(false);
  }catch(e){
    state.authed = false; state.me = null;
    els.authStatus.textContent = 'Non connect√©';
    els.btnLogout.style.display = 'none';
    setOverlay(true);
  }
}

els.btnLogin.onclick = async()=>{
  try{ await api('/auth/login',{method:'POST', body:{email:els.email.value.trim(), password:els.password.value}}); toast('Connect√© ‚úî'); await checkAuth(); }
  catch(e){ toast('Erreur: ' + e.message); }
};
els.btnSignup.onclick = async()=>{
  try{ await api('/auth/signup',{method:'POST', body:{email:els.email.value.trim(), password:els.password.value}}); toast('Compte cr√©√©, vous pouvez vous connecter.'); }
  catch(e){ toast('Erreur: ' + e.message); }
};
els.btnLogout.onclick = async()=>{
  try{ await api('/auth/logout',{method:'POST'}); toast('D√©connect√©.'); }catch(_){}
  await checkAuth();
};

// --- G√©oloc / Recherche (placeholders: r√©int√®gre ton code existant ici) ---
function isAndroid(){ return /Android/i.test(navigator.userAgent); }
function isStandalone(){
  return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches)
         || window.navigator.standalone === true;
}
function openMaps({name, addr, lat, lon, place_id}){
  const label = name || addr || '';
  if(isAndroid() && isStandalone() && lat && lon){
    const geo = `geo:${lat},${lon}?q=${encodeURIComponent(label)}@${lat},${lon}`;
    window.location.href = geo; return;
  }
  let url='';
  if(place_id){ url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(label)}&query_place_id=${encodeURIComponent(place_id)}`; }
  else if(lat&&lon){ url=`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`; }
  else{ url=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(label)}`; }
  window.open(url,'_blank','noopener,noreferrer');
}

els.btnSearch.addEventListener('click', async()=>{
  if(!state.authed){ setOverlay(true); return; }
  // ... ici r√©utilise TA logique de recherche existante (appel Worker /nearby, rendu des r√©sultats, etc.)
  els.results.innerHTML = '<div class="muted">(R√©sultats ici une fois connect√©)</div>';
});

// Lancer l‚Äôapp
checkAuth();
</script>
</body>
</html>
