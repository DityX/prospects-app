<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Prospects proches ‚Äì Mobile</title>
  <style>
    :root{--bg:#0b0f17;--card:#121829;--txt:#e7ecf3;--muted:#92a1b2;--line:#1e2a3f;--accent:#4f46e5}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0b0f17,#0b0f17d0);backdrop-filter:blur(4px);padding:12px 16px;border-bottom:1px solid var(--line)}
    .wrap{max-width:680px;margin:0 auto;padding:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px}
    .row{display:grid;gap:10px}
    .btn{width:100%;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px;border-radius:14px;border:1px solid #24314b;background:#19243a;color:var(--txt);font-weight:700}
    .btn.primary{background:var(--accent);border-color:transparent}
    .btn.ghost{background:transparent}
    .seg{display:flex;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .seg button{flex:1;padding:12px;border:0;background:#0f1422;color:var(--txt)}
    .seg button.on{background:#222a42}
    label{font-size:12px;color:var(--muted);display:block;margin:6px 2px}
    select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1422;color:var(--txt)}
    .badges{display:flex;flex-wrap:wrap;gap:6px}
    .badge{font-size:12px;background:#1a2240;border:1px solid #2a3561;border-radius:999px;padding:4px 8px;color:#cfe1ff}
    .poi{display:flex;gap:10px;align-items:flex-start;border:1px solid var(--line);border-radius:14px;padding:12px;background:#0f1422}
    a{color:#9ec6ff;text-decoration:none}
    a:hover{text-decoration:underline}
    .muted{color:var(--muted)}
    .big{font-size:18px;font-weight:800}
    .city{font-weight:800}
  </style>
  <meta name="theme-color" content="#0b0f17"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Prospects Mobile"/>
  <script>
  // PWA minimal (manifest + SW √† la vol√©e)
  (function(){
    function icon(size){const c=document.createElement('canvas');c.width=c.height=size;const g=c.getContext('2d');g.fillStyle='#0b0f17';g.fillRect(0,0,size,size);g.fillStyle='#4f46e5';g.beginPath();g.arc(size/2,size/2,size*0.42,0,Math.PI*2);g.fill();g.fillStyle='#fff';g.font=`${Math.floor(size*0.42)}px system-ui`;g.textAlign='center';g.textBaseline='middle';g.fillText('üìç',size/2,size/2+size*0.04);return c.toDataURL('image/png')} 
    const manifest={name:'Prospects proches',short_name:'Prospects',start_url:'./',display:'standalone',theme_color:'#0b0f17',background_color:'#0b0f17',icons:[{src:icon(192),sizes:'192x192',type:'image/png',purpose:'any maskable'},{src:icon(512),sizes:'512x512',type:'image/png',purpose:'any maskable'}]};
    const u=URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'}));const l=document.createElement('link');l.rel='manifest';l.href=u;document.head.appendChild(l);
    const sw=`const C='prospects-mob-v1';self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll([self.location.pathname])));self.skipWaiting()});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(k=>Promise.all(k.filter(x=>x!==C).map(x=>caches.delete(x)))));self.clients.claim()});self.addEventListener('fetch',e=>{const r=e.request;if(r.url.includes('overpass-api')||r.url.includes('nominatim')){e.respondWith(fetch(r).catch(()=>caches.match(r)))}else{e.respondWith(caches.match(r).then(m=>m||fetch(r).then(res=>{const cl=res.clone();caches.open(C).then(c=>c.put(r,cl));return res}).catch(()=>caches.match(self.location.pathname))))}})`;
    if('serviceWorker' in navigator){navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'text/javascript'})))}
  })();
  </script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="big">Prospects proches</div>
      <div class="muted" id="cityLine">Ville : <span class="city" id="city">‚Äî</span></div>
    </div>
  </header>
  <div id="toast" style="position:fixed;left:12px;right:12px;bottom:12px;background:#0f1422;border:1px solid #27314c;border-radius:12px;padding:10px 12px;color:#e7ecf3;display:none;z-index:99"></div>
  <main class="wrap row" style="padding-bottom:80px;">
    <section class="card row">
      <div class="row" style="gap:8px;">
        <button class="btn" id="btnLocate">üìç Me g√©olocaliser</button>
        <button class="btn ghost" id="btnReset">‚ôªÔ∏è R√©initialiser le cache</button>
      </div>
      <div class="row" style="grid-template-columns:1fr 1fr; gap:8px;">
        <div>
          <label>Rayon</label>
          <select id="radius">
            <option value="5">5 km</option>
            <option value="10" selected>10 km</option>
            <option value="15">15 km</option>
            <option value="20">20 km</option>
          </select>
        </div>
        <div>
          <label>Nombre max</label>
          <select id="limit">
            <option>3</option>
            <option selected>5</option>
            <option>10</option>
          </select>
        </div>
      </div>
      <div>
        <label>Cat√©gories</label>
        <div class="seg" id="catSeg">
          <button data-id="enr" class="on">ENR</button>
          <button data-id="dep_ch" class="">D√©pannage chauffage</button>
          <button data-id="pose_ch" class="">Chauffagiste (pose)</button>
          <button data-id="sanitaire" class="">Sanitaire</button>
        </div>
        <div class="muted" style="margin-top:6px;font-size:12px">Touchez pour (d√©)s√©lectionner une ou plusieurs cat√©gories.</div>
      </div>
      <div class="row" style="gap:8px; margin-top:6px;">
        <button class="btn primary" id="btnSearch">üîé Trouver des prospects</button>
      </div>
    </section>

    <section class="row" id="resultsWrap"></section>
  </main>

  <script>
  const qs=(s,el=document)=>el.querySelector(s); const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
  const toast=(msg)=>{ const t=qs('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(window.__t); window.__t=setTimeout(()=>t.style.display='none', 3500); }
  const deg2rad=d=>d*Math.PI/180; const R=6371000; const dist=(a,b)=>{const dLat=deg2rad(b.lat-a.lat), dLon=deg2rad(b.lon-a.lon);const A=Math.sin(dLat/2)**2+Math.cos(deg2rad(a.lat))*Math.cos(deg2rad(b.lat))*Math.sin(dLon/2)**2;return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A))};

  const CATS = {
    enr: { label:'ENR', keywords: 'clim|climatisation|pompe √† chaleur|PAC|a√©rotherm|g√©otherm' },
    dep_ch: { label:'D√©pannage chauffage', keywords: 'd√©pann|urgence|chaudi[e√®]re|panne|chauffage' },
    pose_ch: { label:'Chauffagiste (pose)', keywords: 'chauffag|pose|install(ation|er)|chaudi[e√®]re|radiateur' },
    sanitaire: { label:'Sanitaire', keywords: 'plomb|sanitair|salle de bain|douche|wc' , osm: 'craft=plumber'},
  };

  // UI cats toggles
  qsa('#catSeg button').forEach(b=> b.onclick=()=> b.classList.toggle('on'));

  // Reverse geocode city with Nominatim
  async function getCity(lat,lon){
    try{
      const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
      const r = await fetch(url,{headers:{'Accept':'application/json'}});
      const j = await r.json();
      const c = j.address && (j.address.city || j.address.town || j.address.village || j.address.municipality || j.address.county) || '‚Äî';
      qs('#city').textContent = c;
    }catch(e){ console.warn('reverse geocode',e); qs('#city').textContent='‚Äî'; }
  }

  let center = null; // {lat,lon}

  qs('#btnLocate').onclick = async () => {
    try{
      if(!('geolocation' in navigator)) { toast('G√©olocalisation non disponible sur ce navigateur.'); return; }
      // Check permission when available
      if(navigator.permissions && navigator.permissions.query){
        try{
          const p = await navigator.permissions.query({name:'geolocation'});
          if(p.state==='denied'){
            toast('Acc√®s localisation refus√©. Active-le dans les r√©glages du site.');
            // Guidance by platform
            const ua = navigator.userAgent.toLowerCase();
            if(/iphone|ipad|ipod/.test(ua)){
              setTimeout(()=>alert('iPhone : R√©glages > Confidentialit√© > Service de localisation > Safari Websites > "Pendant l\'utilisation".
Puis rouvrez l\'app et r√©essayez.')),50;
            } else {
              setTimeout(()=>alert('Android : Chrome > cadenas / i > Autorisations du site > Localisation > Autoriser.
Puis r√©essayez.')),50;
            }
            return;
          }
        }catch(e){}
      }
      toast('Recherche de la position‚Ä¶');
      navigator.geolocation.getCurrentPosition(pos=>{
        center = { lat: +pos.coords.latitude.toFixed(6), lon: +pos.coords.longitude.toFixed(6) };
        getCity(center.lat, center.lon);
        toast('Position d√©tect√©e.');
      }, err=>{
        toast('Erreur g√©oloc : '+err.message);
      }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
    }catch(e){ toast('Erreur : '+e.message); }
  };
      getCity(center.lat, center.lon);
    }, err=> alert('Erreur g√©oloc: '+err.message), {enableHighAccuracy:true,timeout:10000,maximumAge:0});
  };

  function buildOverpassQuery(lat,lon,km,cats){
    const r = km*1000; const parts=[];
    const addFilter = f=>{ parts.push(`node[${f}](around:${r},${lat},${lon});`); parts.push(`way[${f}](around:${r},${lat},${lon});`); parts.push(`relation[${f}](around:${r},${lat},${lon});`); };
    // Always include keyword search on name/description for selected cats
    const kw = cats.map(c=>CATS[c].keywords).filter(Boolean).join('|');
    if(kw){ const safe=kw.replace(/"/g,''); ['node','way','relation'].forEach(t=> parts.push(`${t}[~"name|description|craft|shop|office"~"${safe}"](around:${r},${lat},${lon});`)); }
    // Add strict OSM tags where known (e.g., craft=plumber)
    cats.forEach(c=>{ if(CATS[c].osm){ addFilter(CATS[c].osm); } });
    return `
[out:json][timeout:25];(
${parts.join('
')}
);out center ${Math.min(200, 60)};`;
  }

  async function fetchOverpass(q){
    const resp = await fetch('https://overpass-api.de/api/interpreter',{method:'POST',headers:{'Content-Type':'text/plain'},body:q});
    if(!resp.ok) throw new Error('Overpass '+resp.status); return resp.json();
  }

  function normalize(elements){
    const seen=new Set(); const out=[];
    for(const el of elements){
      const lat = el.lat || (el.center&&el.center.lat); const lon = el.lon || (el.center&&el.center.lon); if(lat==null||lon==null) continue;
      const key=(el.tags?.name||'')+lat.toFixed(4)+lon.toFixed(4); if(seen.has(key)) continue; seen.add(key);
      const name=el.tags?.name || '‚àÖ Sans nom';
      const tags=el.tags||{}; const address=[tags['addr:housenumber'],tags['addr:street'],tags['addr:postcode'],tags['addr:city']].filter(Boolean).join(' ');
      out.push({name,lat,lon,address,tags});
    }
    return out;
  }

  function render(list){
    const wrap=qs('#resultsWrap'); wrap.innerHTML='';
    if(!list.length){ wrap.innerHTML = `<div class="muted">Aucun r√©sultat avec ces filtres.</div>`; return; }
    list.forEach(p=>{
      const d = dist(center,{lat:p.lat,lon:p.lon});
      const el=document.createElement('div'); el.className='poi';
      el.innerHTML=`<div style="flex:1;">
        <div style="font-weight:800;">${p.name}</div>
        <div class="muted" style="font-size:12px;">${(d/1000).toFixed(2)} km ‚Ä¢ ${p.address||'Adresse inconnue'}</div>
        <div class="badges" style="margin-top:6px;">
          <a class="badge" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.name+' @ '+p.lat+','+p.lon)}">Google Maps</a>
          <a class="badge" target="_blank" href="https://www.openstreetmap.org/?mlat=${p.lat}&mlon=${p.lon}#map=18/${p.lat}/${p.lon}">OSM</a>
        </div>
      </div>`;
      wrap.appendChild(el);
    });
  }

  qs('#btnSearch').onclick = async ()=>{
    try{
      if(!center){ alert('Clique d\'abord sur "Me g√©olocaliser".'); return; }
      const cats = qsa('#catSeg button.on').map(b=>b.dataset.id); if(!cats.length){ alert('Choisis au moins une cat√©gorie.'); return; }
      const q = buildOverpassQuery(center.lat, center.lon, parseInt(qs('#radius').value), cats);
      qs('#resultsWrap').innerHTML = '<div class="muted">Recherche en cours‚Ä¶</div>';
      const data = await fetchOverpass(q);
      let list = normalize(data.elements||[]);
      // Tri par distance √† la fin + limite
      list.sort((a,b)=>dist(center,{lat:a.lat,lon:a.lon})-dist(center,{lat:b.lat,lon:b.lon}));
      const max = parseInt(qs('#limit').value)||5; list = list.slice(0, max);
      render(list);
    }catch(err){ console.error(err); alert('Erreur: '+err.message); }
  }

  // Auto-locate at first load if possible
  if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=>{center={lat:+p.coords.latitude.toFixed(6),lon:+p.coords.longitude.toFixed(6)}; getCity(center.lat,center.lon);}, ()=>{}); }
    qs('#btnReset').onclick = async ()=>{
    try{
      // Clear caches + unregister SW then reload
      if('caches' in window){ const keys = await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }
      if('serviceWorker' in navigator){ const regs = await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister())); }
      localStorage.clear();
      toast('Cache vid√©. Rechargement‚Ä¶'); setTimeout(()=>location.reload(),600);
    }catch(e){ toast('Impossible de vider le cache : '+e.message); }
  };
  </script>
</body>
</html>
