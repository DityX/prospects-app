<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Prospects proches ‚Äì v1.3.3</title>
  <style>
    :root{--bg:#0f141b;--panel:#152033;--card:#0f192d;--muted:#9db2ce;--text:#eaf2ff;--accent:#6558ff;--accent2:#7a6dff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .title{font-weight:800;font-size:22px;margin:0}
    .pill{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:6px 10px;font-size:13px}
    .city{color:var(--muted);margin:0 0 8px}
    .card{background:var(--panel);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .text{flex:1;min-width:160px;padding:10px 12px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:var(--text)}
    select{padding:10px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:var(--text)}
    .btn{background:#1b2844;color:var(--text);border:1px solid #223456;border-radius:12px;padding:11px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:var(--accent);border-color:var(--accent2);font-weight:700}
    .results{margin-top:12px}
    .item{background:var(--card);border:1px solid #203050;border-radius:12px;padding:12px;margin-top:10px}
    .muted{color:var(--muted)}
    .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .8s linear infinite;margin-right:8px;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .overlay{position:fixed;inset:0;background:rgba(5,10,20,.85);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .panel{background:#0f192d;border:1px solid #203050;border-radius:16px;max-width:420px;width:100%;padding:18px}

    /* --- Chips (filtres m√©tiers) --- */
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .chip{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:7px 12px;cursor:pointer;font-size:14px;user-select:none}
    .chip.active{background:var(--accent);border-color:var(--accent2);color:#fff}

    /* --- Badges & status --- */
    .badge{display:inline-block;background:#1b2844;border:1px solid #223456;border-radius:999px;padding:2px 8px;font-size:12px;color:#cfe1ff}
    .statusbar{color:var(--muted);margin:6px 0 12px;font-size:14px}

    /* --- Boutons flottants mobile --- */
    .fab{position:fixed;right:16px;bottom:16px;background:var(--accent);border:1px solid var(--accent2);color:#fff;border-radius:999px;padding:12px 14px;cursor:pointer;box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:9998}
    .fab-top{bottom:72px;display:none}

    /* --- Petit bouton ic√¥ne --- */
    .btn-icon{width:42px;height:42px;display:inline-flex;align-items:center;justify-content:center;border-radius:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 class="title">Prospects proches</h1>
    <div id="authStatus" class="pill">Non connect√©</div>
  </div>
  <div class="city">Ville : <span id="city">‚Äî</span></div>
  <div id="statusBar" class="statusbar">Connect√© ? ‚Ä¢ Filtres: 0 ‚Ä¢ Ville: ‚Äî</div>

  <div class="card">
    <div class="row">
      <button id="btnGeoloc" class="btn">üìç Me g√©olocaliser</button>
      <button id="btnManual" class="btn" title="Entrer ma position manuellement">‚úçÔ∏è Entrer ma position</button>
      <input id="lat" class="text" placeholder="lat" style="display:none;width:140px">
      <input id="lon" class="text" placeholder="lon" style="display:none;width:160px">
      <button id="btnUseManual" class="btn" style="display:none">‚úÖ Utiliser cette position</button>
      <select id="radius">
        <option value="3000">3 km</option>
        <option value="5000">5 km</option>
        <option value="10000" selected>10 km</option>
        <option value="20000">20 km</option>
      </select>
      <input id="keyword" class="text" placeholder="Mot‚Äëcl√© (ex: plombier)" value="plombier" />
      <label style="display:flex;gap:6px;align-items:center"><input id="onlyOpen" type="checkbox"/> Uniquement ouverts</label>
      <select id="limit" title="Nombre max de r√©sultats">
        <option value="3">3</option>
        <option value="5" selected>5</option>
        <option value="10">10</option>
      </select>
      <button id="btnSearch" class="btn btn-primary" style="margin-left:auto">üîé Chercher</button>
      <button id="btnLogout" class="btn" style="display:none">üö™ D√©connexion</button>
    </div>

    <!-- Chips m√©tiers -->
    <div class="chips" id="chips">
      <div class="chip active" data-cat="all">Tous</div>
      <div class="chip" data-cat="enr">ENR</div>
      <div class="chip" data-cat="depannage">D√©pannage chaudi√®re</div>
      <div class="chip" data-cat="sanitaire">Sanitaire</div>
      <div class="chip" data-cat="chauffagiste">Chauffagiste</div>
    </div>

    <div id="results" class="results muted">(R√©sultats ici une fois connect√©)</div>
  </div>
</div>

<!-- Auth overlay -->
<div id="authOverlay" class="overlay">
  <div class="panel">
    <h3>Connexion requise</h3>
    <div class="row"><input id="email" class="text" type="email" placeholder="E‚Äëmail" autocomplete="username"></div>
    <div class="row"><input id="password" class="text" type="password" placeholder="Mot de passe (‚â• 8)" autocomplete="current-password"></div>
    <div class="row">
      <button id="btnLogin" class="btn btn-primary">Se connecter</button>
      <button id="btnSignup" class="btn">Cr√©er mon compte</button>
    </div>
    <div id="authMsg" class="muted"></div>
  </div>
</div>

<button id="fabGeo" class="fab">üìç</button>
<button id="toTop" class="fab fab-top">‚Üë</button>

<script>
const WORKER_URL = "https://restless-heart-0d76.thiery-dimitri-pro.workers.dev";
const $ = (id)=>document.getElementById(id);
const ui = {city: $('city'), res: $('results'), btnGeo: $('btnGeoloc'), btnManual: $('btnManual'), lat:$('lat'), lon:$('lon'), use:$('btnUseManual'), radius:$('radius'), kw:$('keyword'), only:$('onlyOpen'), search:$('btnSearch'), logout:$('btnLogout'), overlay:$('authOverlay'), email:$('email'), pass:$('password'), login:$('btnLogin'), signup:$('btnSignup'), msg:$('authMsg'), status:$('authStatus')};
ui.chips = $('chips'); ui.limit = $('limit'); ui.statusBar = $('statusBar'); ui.fabGeo = $('fabGeo'); ui.toTop = $('toTop');
let state = {lat:null, lon:null, authed:false, me:null};

function setOverlay(v){ ui.overlay.style.display = v?'flex':'none'; }
function toast(t){ ui.msg.textContent = t; }
async function api(path, opt={}){
  const res = await fetch(WORKER_URL+path,{method:opt.method||'GET', headers:{'content-type':'application/json'}, credentials:'include', body: opt.body?JSON.stringify(opt.body):undefined});
  if(res.status===401) throw new Error('401');
  const j = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(j.error||res.statusText); return j;
}
async function checkAuth(){
  try{ const me = await api('/auth/me'); state.authed=true; state.me=me; ui.status.textContent='Connect√©: '+(me.email||''); ui.logout.style.display=''; setOverlay(false); ui.res.textContent=''; updateStatus(); }
  catch(_){ state.authed=false; ui.status.textContent='Non connect√©'; ui.logout.style.display='none'; setOverlay(true); updateStatus(); }
}
ui.login.onclick = async()=>{ try{ await api('/auth/login',{method:'POST',body:{email:ui.email.value.trim(),password:ui.pass.value}}); toast('Connect√© ‚úî'); await checkAuth(); }catch(e){ toast(e.message==='401'?'Identifiants invalides':'Erreur: '+e.message);} };
ui.signup.onclick = async()=>{ try{ await api('/auth/signup',{method:'POST',body:{email:ui.email.value.trim(),password:ui.pass.value}}); toast('Compte cr√©√©, connectez‚Äëvous.'); }catch(e){ toast('Erreur: '+e.message);} };
ui.logout.onclick = async()=>{ try{ await api('/auth/logout',{method:'POST'}); }catch(_){ } await checkAuth(); };

// --- Cat√©gories -> mots-cl√©s
const CAT_KEYWORDS = {
  enr: ['pompe √† chaleur','climatisation','ENR','chauffage r√©versible'],
  depannage: ['d√©pannage chaudi√®re','entretien chaudi√®re','r√©paration chaudi√®re'],
  sanitaire: ['plombier','sanitaire','salle de bain','d√©pannage plomberie'],
  chauffagiste: ['chauffagiste','pose chaudi√®re','installation chauffage']
};

// --- Prefs
const LS_KEY = 'prospects_prefs_v13';
function savePrefs(){
  const selected = Array.from(ui.chips?.querySelectorAll?.('.chip.active')||[]).map(c=>c.dataset.cat);
  try{
    localStorage.setItem(LS_KEY, JSON.stringify({
      cats: selected,
      radius: ui.radius ? ui.radius.value : undefined,
      only: ui.only ? ui.only.checked : undefined,
      limit: ui.limit ? ui.limit.value : undefined,
      keyword: ui.kw ? ui.kw.value : undefined
    }));
  }catch(_){ /* localStorage may be unavailable */ }
}
function loadPrefs(){
  try{
    const j = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
    if(j.radius && ui.radius) ui.radius.value=j.radius;
    if(typeof j.only==='boolean' && ui.only) ui.only.checked=j.only;
    if(j.limit && ui.limit) ui.limit.value=j.limit;
    if(typeof j.keyword==='string' && ui.kw) ui.kw.value=j.keyword;
    if(Array.isArray(j.cats) && j.cats.length && ui.chips){
      ui.chips.querySelectorAll('.chip').forEach(ch=>ch.classList.remove('active'));
      j.cats.forEach(code=>{ const el = ui.chips.querySelector(`.chip[data-cat="${code}"]`); if(el) el.classList.add('active'); });
      if(!ui.chips.querySelector('.chip.active')) ui.chips.querySelector('[data-cat="all"]').classList.add('active');
    }
  }catch(_){ /* ignore corrupted prefs */ }
}

function updateStatus(){
  const authed = state.authed ? 'Connect√© ‚úî' : 'Non connect√©';
  const activeCats = Array.from(ui.chips?.querySelectorAll?.('.chip.active')||[]).map(c=>c.dataset.cat).filter(c=>c!=='all');
  const kwHas = !!(ui.kw && typeof ui.kw.value==='string' && ui.kw.value.trim());
  const onlyOpen = !!(ui.only && ui.only.checked);
  const nFilters = (activeCats.length?1:0) + (onlyOpen?1:0) + (kwHas?1:0);
  const city = ui.city?.textContent || '‚Äî';
  if(ui.statusBar) ui.statusBar.textContent = `${authed} ‚Ä¢ Filtres: ${nFilters} ‚Ä¢ Ville: ${city}`;
}

// GEO auto
ui.btnGeo.onclick = ()=>{
  if(!state.authed) return setOverlay(true);
  ui.city.textContent='Localisation‚Ä¶';
  navigator.geolocation.getCurrentPosition(async(pos)=>{
    state.lat=pos.coords.latitude; state.lon=pos.coords.longitude;
    try{ const g=await api(`/geocode?lat=${state.lat}&lon=${state.lon}`); const city = (g?.results?.[0]?.address_components||[]).find(c=>c.types.includes('locality'))?.long_name || g?.results?.[0]?.formatted_address || '‚Äî'; ui.city.textContent=city; }
    catch(e){ ui.city.textContent='‚Äî'; }
    updateStatus(); savePrefs();
  },(err)=>{
    ui.city.textContent='‚Äî'; alert('G√©olocalisation refus√©e ou indisponible. Utilise "Entrer ma position".');
    ui.btnManual.click(); updateStatus();
  },{enableHighAccuracy:true,timeout:10000});
};

// GEO manuelle
ui.btnManual.onclick = ()=>{ ui.lat.style.display=ui.lon.style.display=ui.use.style.display=''; ui.lat.focus(); };
ui.use.onclick = async()=>{
  const lat=parseFloat(ui.lat.value.replace(',','.')); const lon=parseFloat(ui.lon.value.replace(',','.'));
  if(Number.isFinite(lat)&&Number.isFinite(lon)){
    state.lat=lat; state.lon=lon; try{ const g=await api(`/geocode?lat=${lat}&lon=${lon}`); const city=g?.results?.[0]?.formatted_address||'‚Äî'; ui.city.textContent=city; }catch(_){ ui.city.textContent='‚Äî'; }
    updateStatus(); savePrefs();
  }
  else alert('Coordonn√©es invalides');
};

// Chips interactions
ui.chips.addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  const code = chip.dataset.cat;
  if(code === 'all'){
    ui.chips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
  }else{
    chip.classList.toggle('active');
    const actives = ui.chips.querySelectorAll('.chip.active');
    const anyCat = Array.from(actives).some(c=>c.dataset.cat!=='all');
    const allChip = ui.chips.querySelector('[data-cat="all"]');
    if(anyCat) allChip.classList.remove('active');
    if(!anyCat) allChip.classList.add('active');
  }
  savePrefs(); updateStatus();
});

// Hooks sauvegarde
['change','input'].forEach(ev=>{
  ui.radius && ui.radius.addEventListener(ev, ()=>{ savePrefs(); updateStatus(); });
  ui.only && ui.only.addEventListener(ev, ()=>{ savePrefs(); updateStatus(); });
  ui.limit && ui.limit.addEventListener(ev, ()=>{ savePrefs(); updateStatus(); });
  ui.kw && ui.kw.addEventListener(ev, ()=>{ savePrefs(); updateStatus(); });
});

// Boutons flottants & scroll
ui.fabGeo.onclick = ()=> ui.btnGeo.click();
ui.toTop.onclick = ()=> window.scrollTo({top:0, behavior:'smooth'});
window.addEventListener('scroll', ()=>{
  const many = (ui.res.children?.length||0) >= 6 || window.scrollY>400;
  ui.toTop.style.display = many ? '' : 'none';
});

// Utils distance + tri statut
function haversineKm(lat1,lon1,lat2,lon2){
  const R=6371, toRad = d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.asin(Math.sqrt(a));
}
function sortByStatus(items){
  const rank = v => v===true?0 : v===false?1 : 2;
  return items.sort((a,b)=> rank(a.opening_hours?.open_now) - rank(b.opening_hours?.open_now));
}

// Recherche (adapt√©e)
ui.search.onclick = async ()=>{
  if(!state.authed) return setOverlay(true);
  if(!state.lat||!state.lon) return alert('D√©finis ta position (g√©oloc ou manuelle).');
  ui.res.innerHTML='<span class="spinner"></span> Recherche en cours‚Ä¶';

  const activeCats = Array.from(ui.chips.querySelectorAll('.chip.active')).map(c=>c.dataset.cat).filter(c=>c!=='all');
  let keyword = (ui.kw && typeof ui.kw.value==='string') ? ui.kw.value.trim() : '';
  if(activeCats.length){
    const bag = [];
    activeCats.forEach(code => (CAT_KEYWORDS[code]||[]).forEach(k=>bag.push(k)));
    if(!keyword) keyword = bag.join(' ');
  }
  if(!keyword) keyword = 'plombier';

  try{
    const url = new URL(WORKER_URL+'/nearby');
    url.searchParams.set('lat',state.lat);
    url.searchParams.set('lon',state.lon);
    url.searchParams.set('radius',ui.radius ? ui.radius.value : '10000');
    url.searchParams.set('keyword',keyword);
    if(ui.only && ui.only.checked) url.searchParams.set('opennow','true');

    const data = await fetch(url,{credentials:'include'}).then(r=>r.json());
    let items = data?.results||[];
    if(!items.length){ ui.res.textContent='Aucun r√©sultat.'; updateStatus(); return; }

    items = items.map(r=>{
      const lat=r.geometry?.location?.lat, lon=r.geometry?.location?.lng;
      const dist = (lat&&lon) ? haversineKm(state.lat,state.lon,lat,lon) : null;
      return {...r, _dist:dist};
    });
    items = sortByStatus(items);

    const limit = parseInt(ui.limit ? ui.limit.value : '5',10)||5;
    const shown = items.slice(0, limit);

    const catLabels = activeCats.map(c=>{
      if(c==='enr') return 'ENR';
      if(c==='depannage') return 'D√©pannage chaudi√®re';
      if(c==='sanitaire') return 'Sanitaire';
      if(c==='chauffagiste') return 'Chauffagiste';
      return c;
    });

    ui.res.innerHTML = shown.map(r=>{
      const name=r.name||'‚Äî';
      const addr=r.vicinity||r.formatted_address||'';
      const open=r.opening_hours?.open_now;
      const badgeOpen=open===true?'üü¢ Ouvert':(open===false?'üî¥ Ferm√©':'‚ö™ Horaires ?');
      const dist = (typeof r._dist==='number') ? `${r._dist.toFixed(1)} km` : '';
      const pid = r.place_id;
      const coords = {name,addr,lat:r.geometry?.location?.lat,lon:r.geometry?.location?.lng,place_id:pid};

      const chipsHtml = (catLabels.length?catLabels:['Tous']).map(lbl=>`<span class="badge">${lbl}</span>`).join(' ');
      const distHtml = dist? `<span class="badge">${dist}</span>` : '';

      return `
      <div class="item">
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:flex-start;flex-wrap:wrap">
          <div>
            <div style="font-weight:700">${name} ${distHtml}</div>
            <div class="muted" style="margin:4px 0">${badgeOpen}</div>
            <div class="muted">üìç ${addr||'‚Äî'}</div>
            <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">${chipsHtml}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-icon" title="Ouvrir dans Maps" onclick='openMaps(${JSON.stringify(coords)})'>üó∫Ô∏è</button>
            <button class="btn" onclick='showDetails("${pid}")'>‚ÑπÔ∏è Infos</button>
          </div>
        </div>
        <div class="muted" id="d_${pid}" style="margin-top:6px"></div>
      </div>`;
    }).join('');

  }catch(e){
    if(String(e).includes('401')) setOverlay(true);
    else ui.res.textContent='Erreur: '+e.message;
  }

  updateStatus(); savePrefs();
};

// Maps + D√©tails (inchang√©s de fond)
window.openMaps = ({name,addr,lat,lon,place_id})=>{
  const label=name||addr||''; let url='';
  if(place_id) url=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(label)}&query_place_id=${encodeURIComponent(place_id)}`;
  else if(lat&&lon) url=`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
  else url=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(label)}`;
  window.open(url,'_blank','noopener');
};
window.showDetails = async (place_id)=>{
  const box=document.getElementById('d_'+place_id); if(!box) return; box.textContent='Chargement‚Ä¶';
  try{ const j=await fetch(WORKER_URL+`/details?place_id=${place_id}`,{credentials:'include'}).then(r=>r.json()); const res=j.result||{}; const tel=res.formatted_phone_number||res.international_phone_number||''; const web=res.website||res.url||''; const telHref=(tel||'').replace(/\s/g,''); box.innerHTML=[tel?`‚òéÔ∏è <a href="tel:${telHref}">${tel}</a>`:'', web?`üåê <a href="${web}" target="_blank">Site</a>`:''].filter(Boolean).join(' ¬∑ ') || 'Aucune info.'; }
  catch(_){ box.textContent='Erreur.'; }
};

checkAuth();
loadPrefs();
updateStatus();

// --- Smoke tests / diagnostics ---
(function runSelfTests(){
  try{
    const required=['radius','keyword','onlyOpen','limit','chips','btnGeoloc','btnSearch'];
    const missing = required.filter(id=> !$(id));
    if(missing.length) console.warn('[Diag] IDs manquants:', missing);
    // updateStatus ne doit pas jeter d'exception
    updateStatus();
    console.log('[Tests] updateStatus OK');
  }catch(e){ console.error('[Tests] updateStatus FAILED', e); }
})();
</script>
</body>
</html>
