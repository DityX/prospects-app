<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Prospects proches ‚Äì v1.3.4</title>
  <style>
    :root{--bg:#0f141b;--panel:#152033;--card:#0f192d;--muted:#9db2ce;--text:#eaf2ff;--accent:#6558ff;--accent2:#7a6dff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .title{font-weight:800;font-size:22px;margin:0}
    .pill{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:6px 10px;font-size:13px}
    .city{color:var(--muted);margin:0 0 18px}
    .card{background:var(--panel);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .text{flex:1;min-width:160px;padding:10px 12px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:var(--text)}
    select{padding:10px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:var(--text)}
    .btn{background:#1b2844;color:var(--text);border:1px solid #223456;border-radius:12px;padding:11px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:var(--accent);border-color:var(--accent2);font-weight:700}
    .results{margin-top:12px}
    .item{background:var(--card);border:1px solid #203050;border-radius:12px;padding:12px;margin-top:10px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;background:#1b2844;border:1px solid #223456;border-radius:999px;padding:2px 8px;font-size:12px;color:#cfe1ff;margin-right:4px}
    .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .8s linear infinite;margin-right:8px;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 class="title">Prospects proches</h1>
    <div id="authStatus" class="pill">Non connect√©</div>
  </div>
  <div class="city">Ville : <span id="city">‚Äî</span></div>

  <div class="card">
    <div class="row">
      <button id="btnGeoloc" class="btn">üìç Me g√©olocaliser</button>
      <button id="btnManual" class="btn" title="Entrer ma position manuellement">‚úçÔ∏è Entrer ma position</button>
      <input id="lat" class="text" placeholder="lat" style="display:none;width:140px">
      <input id="lon" class="text" placeholder="lon" style="display:none;width:160px">
      <button id="btnUseManual" class="btn" style="display:none">‚úÖ Utiliser cette position</button>
      <select id="radius">
        <option value="3000">3 km</option>
        <option value="5000">5 km</option>
        <option value="10000" selected>10 km</option>
        <option value="20000">20 km</option>
      </select>
      <input id="keyword" class="text" placeholder="Mot‚Äëcl√© (ex: plombier)" />
      <label style="display:flex;gap:6px;align-items:center"><input id="onlyOpen" type="checkbox"/> Uniquement ouverts</label>
      <button id="btnSearch" class="btn btn-primary" style="margin-left:auto">üîé Chercher</button>
      <button id="btnLogout" class="btn" style="display:none">üö™ D√©connexion</button>
    </div>

    <div class="chips" id="chips">
      <div class="chip active" data-cat="all">Tous</div>
      <div class="chip" data-cat="enr">ENR</div>
      <div class="chip" data-cat="depannage">D√©pannage chaudi√®re</div>
      <div class="chip" data-cat="sanitaire">Sanitaire</div>
      <div class="chip" data-cat="chauffagiste">Chauffagiste</div>
    </div>

    <div id="results" class="results muted">(R√©sultats ici une fois connect√©)</div>
  </div>
</div>

<script>
const WORKER_URL = "https://restless-heart-0d76.thiery-dimitri-pro.workers.dev";
const $ = (id)=>document.getElementById(id);
const ui = {city: $('city'), res: $('results'), btnGeo: $('btnGeoloc'), btnManual: $('btnManual'), lat:$('lat'), lon:$('lon'), use:$('btnUseManual'), radius:$('radius'), kw:$('keyword'), only:$('onlyOpen'), search:$('btnSearch'), logout:$('btnLogout'), chips:$('chips')};
let state = {lat:null, lon:null, authed:false, me:null};

// Cat√©gories avec mot-cl√© prioritaire + synonymes
const CAT_QUERY = {
  sanitaire: ['plombier','plomberie','d√©pannage plomberie','salle de bain','sanitaire'],
  depannage: ['d√©pannage chaudi√®re','entretien chaudi√®re','r√©paration chaudi√®re'],
  chauffagiste: ['chauffagiste','pose chaudi√®re','installation chauffage'],
  enr: ['pompe √† chaleur','climatisation','chauffage r√©versible','ENR']
};

function setOverlay(v){ document.getElementById('authOverlay').style.display = v?'flex':'none'; }

// Recherche
ui.search.onclick = async()=>{
  if(!state.authed) return setOverlay(true);
  if(!state.lat||!state.lon) return alert('D√©finis ta position.');
  ui.res.innerHTML='<span class="spinner"></span> Recherche en cours‚Ä¶';

  const manualKw = ui.kw.value.trim();
  const activeCats = Array.from(ui.chips.querySelectorAll('.chip.active')).map(c=>c.dataset.cat).filter(c=>c!=='all');

  let results=[];
  if(manualKw){
    // Priorit√© au mot-cl√© manuel => ignore les chips
    results = await fetchNearby(manualKw);
    showResults(results,[`Mot-cl√©: "${manualKw}"`]);
    ui.kw.value='';
    return;
  }

  // Sinon, recherche par cat√©gories
  if(!activeCats.length){
    results = await fetchNearby('plombier');
    showResults(results,['Tous']);
    return;
  }

  let merged={};
  for(const cat of activeCats){
    for(const term of CAT_QUERY[cat]||[]){
      const res = await fetchNearby(term);
      res.forEach(r=> merged[r.place_id]=r);
      if(Object.keys(merged).length >= 10) break;
    }
  }
  results = Object.values(merged);
  showResults(results, activeCats);
};

async function fetchNearby(keyword){
  const url = new URL(WORKER_URL+'/nearby');
  url.searchParams.set('lat',state.lat);
  url.searchParams.set('lon',state.lon);
  url.searchParams.set('radius',ui.radius.value);
  url.searchParams.set('keyword',keyword);
  if(ui.only.checked) url.searchParams.set('opennow','true');
  const data = await fetch(url,{credentials:'include'}).then(r=>r.json());
  return data?.results||[];
}

function showResults(items, badges){
  if(!items.length){ ui.res.textContent='Aucun r√©sultat.'; return; }
  ui.res.innerHTML = items.map(r=>{
    const name=r.name||'‚Äî';
    const addr=r.vicinity||r.formatted_address||'';
    const open=r.opening_hours?.open_now;
    const badgeOpen=open===true?'üü¢ Ouvert':(open===false?'üî¥ Ferm√©':'‚ö™ Horaires ?');
    const badgeHtml = badges.map(b=>`<span class="badge">${b}</span>`).join('');
    return `<div class="item"><div><strong>${name}</strong> ${badgeHtml}</div><div class="muted">${badgeOpen}</div><div class="muted">üìç ${addr}</div></div>`;
  }).join('');
}
</script>
</body>
</html>
