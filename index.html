<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Prospects proches ‚Äì v1.3.3</title>
  <style>
    :root{--bg:#0f141b;--panel:#152033;--card:#0f192d;--muted:#9db2ce;--text:#eaf2ff;--accent:#6558ff;--accent2:#7a6dff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .title{font-weight:800;font-size:22px;margin:0}
    .pill{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:6px 10px;font-size:13px}
    .city{color:var(--muted);margin:0 0 18px}
    .card{background:var(--panel);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .text{flex:1;min-width:160px;padding:10px 12px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:var(--text)}
    select{padding:10px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:var(--text)}
    .btn{background:#1b2844;color:var(--text);border:1px solid #223456;border-radius:12px;padding:11px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:var(--accent);border-color:var(--accent2);font-weight:700}
    .results{margin-top:12px}
    .item{background:var(--card);border:1px solid #203050;border-radius:12px;padding:12px;margin-top:10px}
    .muted{color:var(--muted)}
    .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .8s linear infinite;margin-right:8px;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .overlay{position:fixed;inset:0;background:rgba(5,10,20,.85);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .panel{background:#0f192d;border:1px solid #203050;border-radius:16px;max-width:420px;width:100%;padding:18px}
  </style>
  <meta http-equiv="Cache-Control" content="no-store"/>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 class="title">Prospects proches</h1>
    <div id="authStatus" class="pill">Non connect√©</div>
  </div>
  <div class="city">Ville : <span id="city">‚Äî</span></div>

  <div class="card">
    <div class="row">
      <button id="btnGeoloc" class="btn">üìç Me g√©olocaliser</button>
      <button id="btnManual" class="btn" title="Entrer ma position manuellement">‚úçÔ∏è Entrer ma position</button>
      <input id="lat" class="text" placeholder="lat" style="display:none;width:140px">
      <input id="lon" class="text" placeholder="lon" style="display:none;width:160px">
      <button id="btnUseManual" class="btn" style="display:none">‚úÖ Utiliser cette position</button>
      <select id="radius">
        <option value="3000">3 km</option>
        <option value="5000">5 km</option>
        <option value="10000" selected>10 km</option>
        <option value="20000">20 km</option>
      </select>
      <input id="keyword" class="text" placeholder="Mot‚Äëcl√© (ex: plombier)" value="plombier" />
      <label style="display:flex;gap:6px;align-items:center"><input id="onlyOpen" type="checkbox"/> Uniquement ouverts</label>
      <button id="btnSearch" class="btn btn-primary" style="margin-left:auto">üîé Chercher</button>
      <button id="btnLogout" class="btn" style="display:none">üö™ D√©connexion</button>
    </div>

    <div id="results" class="results muted">(R√©sultats ici une fois connect√©)</div>
  </div>
</div>

<!-- Auth overlay -->
<div id="authOverlay" class="overlay">
  <div class="panel">
    <h3>Connexion requise</h3>
    <div class="row"><input id="email" class="text" type="email" placeholder="E‚Äëmail" autocomplete="username"></div>
    <div class="row"><input id="password" class="text" type="password" placeholder="Mot de passe (‚â• 8)" autocomplete="current-password"></div>
    <div class="row">
      <button id="btnLogin" class="btn btn-primary">Se connecter</button>
      <!-- Bouton cr√©er un compte masqu√© pour la phase de test -->
      <button id="btnSignup" class="btn" style="display:none">Cr√©er mon compte</button>
    </div>
    <div id="authMsg" class="muted"></div>
  </div>
</div>

<script>
// ---- Anti-cache & mise √† jour forc√©e v1.3.3 ----
(async()=>{
  try{
    const APP_VERSION = '1.3.3';
    const key='app_version';
    const prev=localStorage.getItem(key);
    if(prev!==APP_VERSION){
      localStorage.setItem(key,APP_VERSION);
      // 1) Si un ancien service worker existe, on le d√©sinstalle (on stoppe l'ancien cache PWA)
      if('serviceWorker' in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r=>r.unregister().catch(()=>{})));
      }
      // 2) On nettoie les caches du navigateur (si cr√©√©s auparavant)
      if('caches' in window){
        const names = await caches.keys();
        await Promise.all(names.map(n=>caches.delete(n).catch(()=>{})));
      }
      // 3) Petite astuce pour forcer le rafra√Æchissement du document si c'est un PWA d√©j√† ouvert
      if(document.visibilityState==='visible'){
        setTimeout(()=>location.replace(location.href.split('#')[0].split('?')[0]+`?v=${APP_VERSION}`), 150);
      }
    }
  }catch(_){ /* ignore */ }
})();

const WORKER_URL = "https://restless-heart-0d76.thiery-dimitri-pro.workers.dev";
const $ = (id)=>document.getElementById(id);
const ui = {city: $('city'), res: $('results'), btnGeo: $('btnGeoloc'), btnManual: $('btnManual'), lat:$('lat'), lon:$('lon'), use:$('btnUseManual'), radius:$('radius'), kw:$('keyword'), only:$('onlyOpen'), search:$('btnSearch'), logout:$('btnLogout'), overlay:$('authOverlay'), email:$('email'), pass:$('password'), login:$('btnLogin'), signup:$('btnSignup'), msg:$('authMsg'), status:$('authStatus')};
let state = {lat:null, lon:null, authed:false, me:null};

function setOverlay(v){ ui.overlay.style.display = v?'flex':'none'; }
function toast(t){ ui.msg.textContent = t; }
async function api(path, opt={}){
  const res = await fetch(WORKER_URL+path,{method:opt.method||'GET', headers:{'content-type':'application/json'}, credentials:'include', body: opt.body?JSON.stringify(opt.body):undefined});
  if(res.status===401) throw new Error('401');
  const j = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(j.error||res.statusText); return j;
}
async function checkAuth(){
  try{ const me = await api('/auth/me'); state.authed=true; state.me=me; ui.status.textContent='Connect√©: '+(me.email||''); ui.logout.style.display=''; setOverlay(false); ui.res.textContent=''; }
  catch(_){ state.authed=false; ui.status.textContent='Non connect√©'; ui.logout.style.display='none'; setOverlay(true); }
}
ui.login.onclick = async()=>{ try{ await api('/auth/login',{method:'POST',body:{email:ui.email.value.trim(),password:ui.pass.value}}); toast('Connect√© ‚úî'); await checkAuth(); }catch(e){ toast(e.message==='401'?'Identifiants invalides':'Erreur: '+e.message);} };
// signup cach√© volontairement en phase de test
ui.logout.onclick = async()=>{ try{ await api('/auth/logout',{method:'POST'}); }catch(_){ } await checkAuth(); };

// GEO auto
ui.btnGeo.onclick = ()=>{
  if(!state.authed) return setOverlay(true);
  ui.city.textContent='Localisation‚Ä¶';
  navigator.geolocation.getCurrentPosition(async(pos)=>{
    state.lat=pos.coords.latitude; state.lon=pos.coords.longitude;
    try{ const g=await api(`/geocode?lat=${state.lat}&lon=${state.lon}`); const city = (g?.results?.[0]?.address_components||[]).find(c=>c.types.includes('locality'))?.long_name || g?.results?.[0]?.formatted_address || '‚Äî'; ui.city.textContent=city; }
    catch(e){ ui.city.textContent='‚Äî'; }
  },(err)=>{
    ui.city.textContent='‚Äî'; alert('G√©olocalisation refus√©e ou indisponible. Utilise "Entrer ma position".');
    ui.btnManual.click();
  },{enableHighAccuracy:true,timeout:10000});
};

// GEO manuelle
ui.btnManual.onclick = ()=>{ ui.lat.style.display=ui.lon.style.display=ui.use.style.display=''; ui.lat.focus(); };
ui.use.onclick = async()=>{
  const lat=parseFloat(ui.lat.value.replace(',','.')); const lon=parseFloat(ui.lon.value.replace(',','.'));
  if(Number.isFinite(lat)&&Number.isFinite(lon)){ state.lat=lat; state.lon=lon; try{ const g=await api(`/geocode?lat=${lat}&lon=${lon}`); const city=g?.results?.[0]?.formatted_address||'‚Äî'; ui.city.textContent=city; }catch(_){ ui.city.textContent='‚Äî'; } }
  else alert('Coordonn√©es invalides');
};

// SEARCH
ui.search.onclick = async()=>{
  if(!state.authed) return setOverlay(true);
  if(!state.lat||!state.lon) return alert('D√©finis ta position (g√©oloc ou manuelle).');
  ui.res.innerHTML='<span class="spinner"></span> Recherche en cours‚Ä¶';
  try{
    const url = new URL(WORKER_URL+'/nearby');
    url.searchParams.set('lat',state.lat); url.searchParams.set('lon',state.lon);
    url.searchParams.set('radius',ui.radius.value); url.searchParams.set('keyword',(ui.kw.value||'plombier').trim());
    if(ui.only.checked) url.searchParams.set('opennow','true');
    const data = await fetch(url,{credentials:'include'}).then(r=>r.json());
    const items = data?.results||[]; if(!items.length){ ui.res.textContent='Aucun r√©sultat.'; return; }
    ui.res.innerHTML = items.map(r=>{
      const name=r.name||'‚Äî'; const addr=r.vicinity||r.formatted_address||''; const open=r.opening_hours?.open_now; const badge=open===true?'üü¢ Ouvert':(open===false?'üî¥ Ferm√©':'‚ö™ Horaires ?');
      return `<div class="item"><div style="display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap"><div><div style="font-weight:700">${name}</div><div class="muted">${badge}</div><div>${addr}</div></div><div style="display:flex;gap:8px"><button class="btn" onclick='openMaps(${JSON.stringify({name,addr,lat:r.geometry?.location?.lat,lon:r.geometry?.location?.lng,place_id:r.place_id})})'>üó∫Ô∏è Maps</button><button class="btn" onclick='showDetails("${r.place_id}")'>‚ÑπÔ∏è Infos</button></div></div><div class="muted" id="d_${r.place_id}"></div></div>`;
    }).join('');
  }catch(e){ if(String(e).includes('401')) setOverlay(true); else ui.res.textContent='Erreur: '+e.message; }
};

window.openMaps = ({name,addr,lat,lon,place_id})=>{
  const label=name||addr||''; let url='';
  if(place_id) url=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(label)}&query_place_id=${encodeURIComponent(place_id)}`;
  else if(lat&&lon) url=`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
  else url=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(label)}`;
  window.open(url,'_blank','noopener');
};
window.showDetails = async (place_id)=>{
  const box=document.getElementById('d_'+place_id); if(!box) return; box.textContent='Chargement‚Ä¶';
  try{ const j=await fetch(WORKER_URL+`/details?place_id=${place_id}`,{credentials:'include'}).then(r=>r.json()); const res=j.result||{}; const tel=res.formatted_phone_number||res.international_phone_number||''; const web=res.website||res.url||''; const telHref=(tel||'').replace(/\s/g,''); box.innerHTML=[tel?`‚òéÔ∏è <a href="tel:${telHref}">${tel}</a>`:'', web?`üåê <a href="${web}" target="_blank">Site</a>`:''].filter(Boolean).join(' ¬∑ ') || 'Aucune info.'; }
  catch(_){ box.textContent='Erreur.'; }
};

checkAuth();
</script>
</body>
</html>
