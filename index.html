<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prospects proches</title>
<style>
  body{margin:0;background:#0f141b;color:#eaf2ff;font:16px/1.4 system-ui}
  .wrap{max-width:880px;margin:32px auto;padding:0 16px}
  .title{font-weight:700;font-size:22px;margin:0 0 6px}
  .city{color:#9db2ce;margin:0 0 18px}
  .card{background:#152033;border-radius:16px;padding:14px 14px 18px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
  .btn{background:#1b2844;color:#eaf2ff;border:1px solid #223456;border-radius:12px;padding:12px 14px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-primary{background:#6558ff;border-color:#7a6dff;font-weight:600;flex:1}
  select,input[type="checkbox"]{accent-color:#6558ff}
  select{padding:10px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:#eaf2ff;flex:1}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 6px}
  .chip{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .chip.active{background:#6558ff;border-color:#7a6dff;color:#fff}
  .results{margin-top:14px}
  .item{background:#0f192d;border:1px solid #203050;border-radius:12px;padding:12px;margin-top:10px}
  .item a{color:#cfe1ff;text-decoration:none}
  .badge{font-size:12px;opacity:.85}
  .meta{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0}
  .row-slim{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .legend{margin-top:14px;font-size:14px;color:#9db2ce}
  .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .8s linear infinite;margin-right:8px;vertical-align:-3px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="wrap">
  <h1 class="title">Prospects proches</h1>
  <div class="city">Ville : <span id="city">‚Äî</span></div>

  <div class="card">
    <div class="row"><button id="btnGeo" class="btn" style="width:100%">üìç Me g√©olocaliser</button></div>

    <div class="row">
      <select id="radius">
        <option value="5000">5 km</option>
        <option value="10000">10 km</option>
        <option value="20000" selected>20 km</option>
        <option value="30000">30 km</option>
      </select>

      <select id="limit">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="40">40</option>
      </select>

      <select id="sort">
        <option value="dist" selected>Trier : distance</option>
        <option value="name">Trier : nom</option>
      </select>
    </div>

    <div class="row-slim">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="openNow" />
        Uniquement les pros ouverts actuellement
      </label>
      <button id="btnExport" class="btn">‚¨áÔ∏è Export CSV</button>
      <button id="btnSearch" class="btn btn-primary">üîé Trouver des prospects</button>
    </div>

    <div id="cats" class="chips">
      <div class="chip active" data-key="plombier">Sanitaire</div>
      <div class="chip active" data-key="chauffagiste">Chauffage</div>
      <div class="chip active" data-key="climatisation pompe √† chaleur">Climatisation / ENR</div>
    </div>

    <div id="results" class="results"></div>
    <div class="legend">
      üü¢ = Ouvert &nbsp; | &nbsp; üî¥ = Ferm√© &nbsp; | &nbsp; ‚ö™ = Horaires non renseign√©s
    </div>
  </div>
</div>

<script>
const WORKER_URL = "https://restless-heart-0d76.thiery-dimitri-pro.workers.dev";

const els = {
  city: document.getElementById('city'),
  btnGeo: document.getElementById('btnGeo'),
  btnSearch: document.getElementById('btnSearch'),
  btnExport: document.getElementById('btnExport'),
  radius: document.getElementById('radius'),
  limit: document.getElementById('limit'),
  sort: document.getElementById('sort'),
  openNow: document.getElementById('openNow'),
  cats: document.getElementById('cats'),
  results: document.getElementById('results'),
};
let state = {lat:null, lon:null, city:null, results:[]};

function setSearching(on){
  els.btnSearch.disabled = on;
  els.btnSearch.innerHTML = on ? '<span class="spinner"></span>Recherche en cours‚Ä¶' : 'üîé Trouver des prospects';
}
function toast(msg){ els.results.innerHTML = `<div class="item"><strong>${msg}</strong></div>`; }
function distKm(a,b,c,d){
  const R = 6371, toRad = x => x * Math.PI / 180;
  const dLat = toRad(c - a), dLon = toRad(d - b);
  const x = Math.sin(dLat/2)**2 + Math.cos(toRad(a)) * Math.cos(toRad(c)) * Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(x));
}

// chips
els.cats.addEventListener('click', e=>{
  const c=e.target.closest('.chip'); if(!c) return;
  c.classList.toggle('active');
});

// g√©oloc
els.btnGeo.addEventListener('click',()=>{
  navigator.geolocation.getCurrentPosition(async pos=>{
    state.lat=pos.coords.latitude; state.lon=pos.coords.longitude;
    const r = await fetch(`${WORKER_URL}/geocode?lat=${state.lat}&lon=${state.lon}`);
    const j = await r.json();
    state.city = j.results?.[0]?.address_components?.find(c=>c.types.includes("locality"))?.long_name || "‚Äî";
    els.city.textContent = state.city;
    toast("Position enregistr√©e ‚úÖ");
  },()=>toast("Impossible d'obtenir la position (autorisation ?)"));
});

// recherche
els.btnSearch.addEventListener('click', async()=>{
  if(!(state.lat&&state.lon)){ toast("Clique d‚Äôabord sur Me g√©olocaliser."); return; }
  const radius = parseInt(els.radius.value,10);
  const limit  = parseInt(els.limit.value,10);
  const sort   = els.sort.value;
  const openNow = els.openNow.checked;
  const kws = [...document.querySelectorAll('.chip.active')].map(c=>c.dataset.key);

  setSearching(true);
  try{
    let rows = [];
    for(const kw of kws){
      const url = `${WORKER_URL}/nearby?lat=${state.lat}&lon=${state.lon}&radius=${radius}&keyword=${encodeURIComponent(kw)}&opennow=${openNow}`;
      const r = await fetch(url);
      const j = await r.json();
      for(const p of (j.results||[])){
        const lat=p.geometry.location.lat, lon=p.geometry.location.lng;
        const status = p.opening_hours ? (p.opening_hours.open_now ? "open" : "closed") : "unknown";
        rows.push({
          place_id:p.place_id, name:p.name, addr:p.vicinity||"",
          lat, lon, kw, dist: distKm(state.lat,state.lon,lat,lon), status
        });
      }
    }
    rows = rows.sort((a,b)=> (sort==="name" ? a.name.localeCompare(b.name) : a.dist-b.dist)).slice(0, limit);
    state.results = rows;

    if(!rows.length){ toast("Aucun r√©sultat trouv√©."); return; }
    els.results.innerHTML = rows.map((p,i)=>`
      <div class="item">
        <div><strong>${p.name}</strong></div>
        <div class="meta">
          <span>${p.status==="open"?"üü¢ Ouvert":p.status==="closed"?"üî¥ Ferm√©":"‚ö™ Horaires non renseign√©s"}</span>
          <span class="badge">${p.kw} ¬∑ ${p.dist.toFixed(1)} km</span>
          <span class="badge">${p.addr}</span>
        </div>
        <div class="row-slim">
          <a class="btn" target="_blank" href="https://www.google.com/maps?q=${encodeURIComponent(p.name)}@${p.lat},${p.lon}">‚û°Ô∏è Maps</a>
          <button class="btn" onclick="showDetails('${p.place_id}','det-${i}')">üìû Coordonn√©es</button>
        </div>
        <div class="badge" id="det-${i}" style="margin-top:6px;display:none"></div>
      </div>
    `).join("");
  }catch(e){
    toast("Erreur (proxy/Google).");
  }finally{
    setSearching(false);
  }
});

// d√©tails (t√©l√©phone + site)
async function showDetails(placeId,detId){
  const el=document.getElementById(detId);
  if(el.style.display==="block"){ el.style.display="none"; return; }
  el.style.display="block"; el.textContent="Chargement‚Ä¶";
  try{
    const r=await fetch(`${WORKER_URL}/details?place_id=${encodeURIComponent(placeId)}`);
    const j=await r.json();
    const d=j.result||{};
    const tel=d.formatted_phone_number||d.international_phone_number||"‚Äî";
    const web=d.website?`<a target="_blank" href="${d.website}">${d.website}</a>`:"‚Äî";
    el.innerHTML=`‚òéÔ∏è ${tel} &nbsp; ‚Ä¢ &nbsp; üåê ${web}`;
  }catch{
    el.textContent="Impossible de r√©cup√©rer les coordonn√©es.";
  }
}
</script>
</body>
</html>
