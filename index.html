<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prospects proches</title>
<style>
  :root{--bg:#0f141b;--card:#152033;--muted:#9db2ce;--text:#eaf2ff;--accent:#6558ff;--accent-2:#7a6dff;--chip:#1c2a43;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:840px;margin:32px auto;padding:0 16px}
  .title{font-weight:700;font-size:22px;margin:0 0 6px}
  .sub{color:var(--muted);margin:0 0 18px}
  .card{background:var(--card);border-radius:16px;padding:14px 14px 18px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
  .btn{background:#1b2844;color:#eaf2ff;border:1px solid #223456;border-radius:12px;padding:12px 14px;cursor:pointer;width:100%;text-align:center}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--accent);border-color:var(--accent-2);font-weight:600}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:#eaf2ff}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
  .chip{background:var(--chip);border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:8px 12px;cursor:pointer;user-select:none}
  .chip.active{background:var(--accent);border-color:var(--accent-2);color:#fff}
  .hint{color:var(--muted);font-size:13px;margin-top:-2px}
  .results{margin-top:14px}
  .item{background:#0f192d;border:1px solid #203050;border-radius:12px;padding:10px 12px;margin-top:10px}
  .item a{color:#cfe1ff;text-decoration:none}
  .badge{font-size:12px;opacity:.8}
  .city{font-size:14px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Prospects proches</h1>
    <div class="city">Ville : <span id="city">‚Äî</span></div>

    <div class="card">
      <div class="row">
        <button id="btnGeo" class="btn">üìç Me g√©olocaliser</button>
      </div>
      <div class="row">
        <button id="btnReset" class="btn">‚ôªÔ∏è R√©initialiser le cache</button>
      </div>

      <div class="grid">
        <label>
          <div>Rayon</div>
          <select id="radius">
            <option value="5000">5 km</option>
            <option value="10000" selected>10 km</option>
            <option value="15000">15 km</option>
            <option value="20000">20 km</option>
          </select>
        </label>
        <label>
          <div>Nombre max</div>
          <select id="limit">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
          </select>
        </label>
      </div>

      <div style="margin-top:8px">Cat√©gories</div>
      <div id="cats" class="chips">
        <div class="chip active" data-key="enr">ENR</div>
        <div class="chip" data-key="dep">D√©pannage chauffage</div>
        <div class="chip" data-key="pose">Chauffagiste (pose)</div>
        <div class="chip" data-key="san">Sanitaire</div>
      </div>
      <div class="hint">Touchez pour (d√©)s√©lectionner une ou plusieurs cat√©gories.</div>

      <div class="row" style="margin-top:12px">
        <button id="btnSearch" class="btn btn-primary">üîé Trouver des prospects</button>
      </div>

      <div id="results" class="results"></div>
    </div>
  </div>

<script>
const els = {
  city: document.getElementById('city'),
  btnGeo: document.getElementById('btnGeo'),
  btnReset: document.getElementById('btnReset'),
  btnSearch: document.getElementById('btnSearch'),
  radius: document.getElementById('radius'),
  limit: document.getElementById('limit'),
  cats: document.getElementById('cats'),
  results: document.getElementById('results'),
};

let state = {
  lat: null,
  lon: null,
  city: null,
};

const LS_KEY = 'prospects_app_state_v2';

function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
    if(s && typeof s === 'object'){
      state = {...state, ...s};
      if(state.city) els.city.textContent = state.city;
    }
  }catch{}
}
function resetState(){
  localStorage.removeItem(LS_KEY);
  state = {lat:null, lon:null, city:null};
  els.city.textContent = '‚Äî';
  els.results.innerHTML = '';
}

async function reverseGeocode(lat, lon){
  try{
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=fr`, {
      headers: {'User-Agent':'prospects-app/1.0 (contact: none)'}
    });
    const data = await res.json();
    return data.address?.city || data.address?.town || data.address?.village || data.address?.municipality || '‚Äî';
  }catch{ return '‚Äî'; }
}

function toast(msg){
  els.results.innerHTML = `<div class="item"><strong>${msg}</strong></div>` + els.results.innerHTML;
}

function distKm(a,b,c,d){
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a), dLon=toRad(d-b);
  const x= Math.sin(dLat/2)**2 + Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}

// --- CATEGORY FILTERS -> Overpass regex per category (French keywords)
const categoryRegex = {
  enr: "(clim|climat|pompe\\s*a\\s*chaleur|PAC|photovolta|solair|energie|√©nergie)",
  dep: "(depann|d√©pann|chaudi|chauffag|gaz|fioul|SAV)",
  pose:"(chauffag|chaudi|installat|pose)",
  san: "(plomb|sanit|salle\\s*de\\s*bain|robinet|canalis|wc|toilet)"
};

// Build an Overpass QL query
function buildOverpassQuery(lat, lon, radius, activeCats){
  // union of selected category regex
  const re = activeCats.map(k => categoryRegex[k]).join('|');
  // search across node/way/rel names & common tags
  return `
  [out:json][timeout:25];
  (
    node(around:${radius},${lat},${lon})[name~"${re}",i];
    way(around:${radius},${lat},${lon})[name~"${re}",i];
    relation(around:${radius},${lat},${lon})[name~"${re}",i];

    node(around:${radius},${lat},${lon})[craft=plumber];
    way(around:${radius},${lat},${lon})[craft=plumber];
  );
  out center tags;`;
}

function renderList(list){
  if(!list.length){
    els.results.innerHTML = `<div class="item">Aucun r√©sultat dans ce p√©rim√®tre avec ces cat√©gories.</div>`;
    return;
  }
  els.results.innerHTML = list.map(p => {
    const gmaps = `https://www.google.com/maps?q=${encodeURIComponent(p.name)}@${p.lat},${p.lon}`;
    return `
    <div class="item">
      <div><strong>${p.name || 'Prospect sans nom'}</strong></div>
      <div class="badge">${p.categoryLabel} ¬∑ ${p.dist.toFixed(1)} km</div>
      ${p.addr ? `<div class="badge">${p.addr}</div>`:''}
      <div style="margin-top:6px"><a href="${gmaps}" target="_blank" rel="noopener">‚û°Ô∏è Ouvrir dans Google Maps</a></div>
    </div>`;
  }).join('');
}

// --- EVENTS
els.cats.addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip');
  if(!chip) return;
  chip.classList.toggle('active');
});

els.btnReset.addEventListener('click', ()=>{
  resetState();
  toast('Cache r√©initialis√©.');
});

els.btnGeo.addEventListener('click', async ()=>{
  if(!('geolocation' in navigator)){
    toast("La g√©olocalisation n'est pas disponible sur cet appareil.");
    return;
  }
  els.btnGeo.disabled = true;
  els.btnGeo.textContent = 'üìç Localisation en cours‚Ä¶';
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude, longitude} = pos.coords;
    state.lat = latitude; state.lon = longitude;
    state.city = await reverseGeocode(latitude, longitude);
    els.city.textContent = state.city;
    saveState();
    els.btnGeo.textContent = 'üìç Me g√©olocaliser';
    els.btnGeo.disabled = false;
    toast('Position enregistr√©e ‚úÖ');
  }, err=>{
    els.btnGeo.textContent = 'üìç Me g√©olocaliser';
    els.btnGeo.disabled = false;
    toast("Impossible d'obtenir la position (permission refus√©e ?).");
  }, {enableHighAccuracy:true, timeout:15000, maximumAge:30000});
});

els.btnSearch.addEventListener('click', async ()=>{
  const active = [...document.querySelectorAll('.chip.active')].map(c=>c.dataset.key);
  if(!active.length){ toast('S√©lectionne au moins une cat√©gorie.'); return; }
  const radius = parseInt(els.radius.value,10);
  const limit  = parseInt(els.limit.value,10);

  if(!(state.lat && state.lon)){
    toast('Clique d‚Äôabord sur ‚ÄúMe g√©olocaliser‚Äù.');
    return;
  }

  els.btnSearch.disabled = true;
  els.btnSearch.textContent = 'üîé Recherche...';

  try{
    const query = buildOverpassQuery(state.lat, state.lon, radius, active);
    const res = await fetch('https://overpass-api.de/api/interpreter', {
      method:'POST',
      body: query,
      headers: {'Content-Type':'text/plain; charset=UTF-8'}
    });
    const data = await res.json();

    const seen = new Set();
    const prospects = (data.elements||[]).map(el=>{
      const center = el.center || {lat: el.lat, lon: el.lon};
      const name = el.tags?.name || '';
      const addr = [el.tags?.addr_housenumber, el.tags?.addr_street, el.tags?.addr_city].filter(Boolean).join(' ');
      const key = (name||'') + '@' + (center.lat?.toFixed(5)||'') + ',' + (center.lon?.toFixed(5)||'');
      if(seen.has(key)) return null;
      seen.add(key);

      const label = (()=> {
        const n = (name||'').toLowerCase();
        if(new RegExp(categoryRegex.enr,'i').test(n)) return 'ENR';
        if(new RegExp(categoryRegex.dep,'i').test(n)) return 'D√©pannage';
        if(new RegExp(categoryRegex.pose,'i').test(n)) return 'Chauffagiste (pose)';
        if(new RegExp(categoryRegex.san,'i').test(n) || el.tags?.craft==='plumber') return 'Sanitaire';
        return 'Prospect';
      })();

      return {
        name: name || (el.tags?.brand || 'Prospect'),
        lat: center.lat, lon: center.lon,
        addr, categoryLabel: label,
        dist: distKm(state.lat, state.lon, center.lat, center.lon)
      };
    }).filter(Boolean)
      .sort((a,b)=> a.dist - b.dist)
      .slice(0, limit);

    renderList(prospects);
  }catch(e){
    toast("Erreur lors de la recherche (API Overpass satur√©e ? R√©essaie).");
  }finally{
    els.btnSearch.disabled = false;
    els.btnSearch.textContent = 'üîé Trouver des prospects';
  }
});

// init
loadState();
</script>
</body>
</html>
