<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prospects proches</title>
<style>
  body{margin:0;background:#0f141b;color:#eaf2ff;font:16px/1.4 system-ui}
  .wrap{max-width:840px;margin:32px auto;padding:0 16px}
  .title{font-weight:700;font-size:22px;margin:0 0 6px}
  .city{color:#9db2ce;margin:0 0 18px}
  .card{background:#152033;border-radius:16px;padding:14px 14px 18px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
  .btn{background:#1b2844;color:#eaf2ff;border:1px solid #223456;border-radius:12px;padding:12px 14px;cursor:pointer;width:100%;text-align:center}
  .btn-primary{background:#6558ff;border-color:#7a6dff;font-weight:600}
  select{width:100%;padding:10px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:#eaf2ff}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
  .chip{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .chip.active{background:#6558ff;border-color:#7a6dff;color:#fff}
  .results{margin-top:14px}
  .item{background:#0f192d;border:1px solid #203050;border-radius:12px;padding:10px;margin-top:10px}
  .item a{color:#cfe1ff;text-decoration:none}
  .badge{font-size:12px;opacity:.8}
  .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .8s linear infinite;margin-right:8px;vertical-align:-3px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="wrap">
  <h1 class="title">Prospects proches</h1>
  <div class="city">Ville : <span id="city">‚Äî</span></div>
  <div class="card">
    <div class="row"><button id="btnGeo" class="btn">üìç Me g√©olocaliser</button></div>
    <div class="row">
      <select id="radius">
        <option value="5000">5 km</option>
        <option value="10000" selected>10 km</option>
        <option value="20000">20 km</option>
      </select>
      <select id="limit">
        <option value="3">3</option>
        <option value="5" selected>5</option>
        <option value="10">10</option>
      </select>
    </div>
    <div id="cats" class="chips">
      <div class="chip active" data-key="plumber">Sanitaire</div>
      <div class="chip active" data-key="heating">Chauffage</div>
      <div class="chip active" data-key="clim">Climatisation / ENR</div>
    </div>
    <div class="row"><button id="btnSearch" class="btn btn-primary">üîé Trouver des prospects</button></div>
    <div id="results" class="results"></div>
  </div>
</div>

<script>
const API_KEY = "AIzaSyA5pkwLj7tBm8rCfyjLuhyw1mgP_LIxuMs";  // üîë Ta cl√©

const els = {
  city: document.getElementById('city'),
  btnGeo: document.getElementById('btnGeo'),
  btnSearch: document.getElementById('btnSearch'),
  radius: document.getElementById('radius'),
  limit: document.getElementById('limit'),
  cats: document.getElementById('cats'),
  results: document.getElementById('results'),
};
let state = {lat:null, lon:null, city:null};

function setSearching(on){
  els.btnSearch.disabled = on;
  els.btnSearch.innerHTML = on ? '<span class="spinner"></span>Recherche en cours‚Ä¶' : 'üîé Trouver des prospects';
}
function toast(msg){ els.results.innerHTML = `<div class="item"><strong>${msg}</strong></div>`; }
function distKm(a,b,c,d){
  const R=6371,toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a), dLon=toRad(d-b);
  const x=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}

// reverse geocode via Google
async function reverseGeocode(lat, lon){
  const url=`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${API_KEY}&language=fr`;
  const r=await fetch(url);const j=await r.json();
  return j.results[0]?.address_components?.find(c=>c.types.includes("locality"))?.long_name||"‚Äî";
}

// chips
els.cats.addEventListener('click', e=>{
  const c=e.target.closest('.chip');if(!c)return;
  c.classList.toggle('active');
});

// g√©oloc
els.btnGeo.addEventListener('click',()=>{
  navigator.geolocation.getCurrentPosition(async pos=>{
    state.lat=pos.coords.latitude;state.lon=pos.coords.longitude;
    state.city=await reverseGeocode(state.lat,state.lon);
    els.city.textContent=state.city;
    toast("Position enregistr√©e ‚úÖ");
  },()=>toast("Impossible d'obtenir la position."));
});

// recherche Google Places
els.btnSearch.addEventListener('click',async()=>{
  if(!(state.lat&&state.lon)){toast("Clique d‚Äôabord sur Me g√©olocaliser.");return;}
  const radius=parseInt(els.radius.value,10);
  const limit=parseInt(els.limit.value,10);
  const cats=[...document.querySelectorAll('.chip.active')].map(c=>c.dataset.key);

  setSearching(true);
  try{
    let results=[];
    for(const cat of cats){
      let keyword = "plombier";
      if(cat==="heating") keyword="chauffagiste";
      if(cat==="clim") keyword="climatisation pompe √† chaleur";
      const url=`https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${state.lat},${state.lon}&radius=${radius}&keyword=${encodeURIComponent(keyword)}&key=${API_KEY}&language=fr`;
      const r=await fetch(url);const j=await r.json();
      for(const p of (j.results||[])){
        const d=distKm(state.lat,state.lon,p.geometry.location.lat,p.geometry.location.lng);
        results.push({
          name:p.name,
          addr:p.vicinity,
          lat:p.geometry.location.lat,
          lon:p.geometry.location.lng,
          categoryLabel:keyword,
          dist:d
        });
      }
    }
    results=results.sort((a,b)=>a.dist-b.dist).slice(0,limit);

    if(!results.length){toast("Aucun r√©sultat trouv√©.");}
    else{
      els.results.innerHTML=results.map(p=>`
        <div class="item">
          <div><strong>${p.name}</strong></div>
          <div class="badge">${p.categoryLabel} ¬∑ ${p.dist.toFixed(1)} km</div>
          <div class="badge">${p.addr||""}</div>
          <div style="margin-top:6px"><a target="_blank" href="https://www.google.com/maps?q=${encodeURIComponent(p.name)}@${p.lat},${p.lon}">‚û°Ô∏è Ouvrir dans Google Maps</a></div>
        </div>`).join("");
    }
  }catch(e){toast("Erreur API Google.");}
  finally{setSearching(false);}
});
</script>
</body>
</html>
