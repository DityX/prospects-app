<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prospects proches</title>
<style>
  body{margin:0;background:#0f141b;color:#eaf2ff;font:16px/1.4 system-ui}
  .wrap{max-width:880px;margin:32px auto;padding:0 16px}
  .title{font-weight:700;font-size:22px;margin:0 0 6px}
  .city{color:#9db2ce;margin:0 0 18px}
  .card{background:#152033;border-radius:16px;padding:14px 14px 18px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
  .btn{background:#1b2844;color:#eaf2ff;border:1px solid #223456;border-radius:12px;padding:12px 14px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-primary{background:#6558ff;border-color:#7a6dff;font-weight:600;flex:1}
  select,input[type="checkbox"]{accent-color:#6558ff}
  select{padding:10px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:#eaf2ff;flex:1}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 6px}
  .chip{background:#1c2a43;border:1px solid #284068;color:#cfe1ff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .chip.active{background:#6558ff;border-color:#7a6dff;color:#fff}
  .results{margin-top:14px}
  .item{background:#0f192d;border:1px solid #203050;border-radius:12px;padding:12px;margin-top:10px}
  .item a{color:#cfe1ff;text-decoration:none}
  .badge{font-size:12px;opacity:.85}
  .meta{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0}
  .row-slim{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .legend{margin-top:14px;font-size:14px;color:#9db2ce}
  .spinner{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .8s linear infinite;margin-right:8px;vertical-align:-3px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .text{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid #24344f;background:#10203a;color:#eaf2ff}
</style>
</head>
<body>
<div class="wrap">
  <h1 class="title">Prospects proches</h1>
  <div class="city">Ville : <span id="city">‚Äî</span></div>

  <div class="card">
    <div class="row">
      <button id="btnGeo" class="btn" style="width:100%">üìç Me g√©olocaliser</button>
    </div>

    <div class="row">
      <select id="radius">
        <option value="5000">5 km</option>
        <option value="10000">10 km</option>
        <option value="20000" selected>20 km</option>
        <option value="30000">30 km</option>
      </select>

      <select id="limit">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="40">40</option>
      </select>

      <select id="sort">
        <option value="dist" selected>Trier : distance</option>
        <option value="name">Trier : nom</option>
      </select>
    </div>

    <div class="row-slim">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="openNow" />
        Uniquement les pros ouverts actuellement
      </label>

      <!-- NEW: inclure horaires non renseign√©s -->
      <label style="display:flex;align-items:center;gap:8px;opacity:.9">
        <input type="checkbox" id="includeUnknown" disabled />
        Inclure horaires non renseign√©s
      </label>

      <button id="btnExport" class="btn">‚¨áÔ∏è Export CSV</button>
      <button id="btnSearch" class="btn btn-primary">üîé Trouver des prospects</button>
    </div>

    <!-- NEW: mot-cl√© libre -->
    <div class="row">
      <input id="freeKw" class="text" placeholder="Mot-cl√© libre (ex. VMC, photovolta√Øque, salle de bain‚Ä¶)" />
      <button id="btnAddKw" class="btn">‚ûï Ajouter au filtre</button>
      <!-- NEW: reset app -->
      <button id="btnResetApp" class="btn" title="Purger caches + service worker">üßπ R√©initialiser l‚Äôappli</button>
    </div>

    <div id="cats" class="chips">
      <div class="chip active" data-key="plombier">Sanitaire</div>
      <div class="chip active" data-key="chauffagiste">Chauffage</div>
      <div class="chip active" data-key="climatisation pompe √† chaleur">Climatisation / ENR</div>
    </div>

    <div id="results" class="results"></div>
    <div class="legend">
      üü¢ = Ouvert &nbsp; | &nbsp; üî¥ = Ferm√© &nbsp; | &nbsp; ‚ö™ = Horaires non renseign√©s
    </div>
  </div>
</div>

<script>
const WORKER_URL = "https://restless-heart-0d76.thiery-dimitri-pro.workers.dev";

const els = {
  city: document.getElementById('city'),
  btnGeo: document.getElementById('btnGeo'),
  btnSearch: document.getElementById('btnSearch'),
  btnExport: document.getElementById('btnExport'),
  btnAddKw: document.getElementById('btnAddKw'),
  btnResetApp: document.getElementById('btnResetApp'),
  radius: document.getElementById('radius'),
  limit: document.getElementById('limit'),
  sort: document.getElementById('sort'),
  openNow: document.getElementById('openNow'),
  includeUnknown: document.getElementById('includeUnknown'),
  freeKw: document.getElementById('freeKw'),
  cats: document.getElementById('cats'),
  results: document.getElementById('results'),
};

let state = {lat:null, lon:null, city:null, results:[]};

// ---------- Helpers ----------
function setSearching(on){
  els.btnSearch.disabled = on;
  els.btnSearch.innerHTML = on ? '<span class="spinner"></span>Recherche en cours‚Ä¶' : 'üîé Trouver des prospects';
}
function toast(msg){ els.results.innerHTML = `<div class="item"><strong>${msg}</strong></div>`; }
function distKm(a,b,c,d){
  const R = 6371, toRad = x => x * Math.PI / 180;
  const dLat = toRad(c - a), dLon = toRad(d - b);
  const x = Math.sin(dLat/2)**2 + Math.cos(toRad(a)) * Math.cos(toRad(c)) * Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(x));
}
function savePrefs(){
  const data = {
    radius: els.radius.value,
    limit: els.limit.value,
    sort: els.sort.value,
    open: els.openNow.checked,
    includeUnknown: els.includeUnknown.checked
  };
  localStorage.setItem('prefs_v1', JSON.stringify(data));
}
function loadPrefs(){
  try{
    const j = JSON.parse(localStorage.getItem('prefs_v1')||'{}');
    if(j.radius) els.radius.value = j.radius;
    if(j.limit) els.limit.value = j.limit;
    if(j.sort) els.sort.value = j.sort;
    if(typeof j.open === 'boolean') els.openNow.checked = j.open;
    if(typeof j.includeUnknown === 'boolean') els.includeUnknown.checked = j.includeUnknown;
    els.includeUnknown.disabled = !els.openNow.checked;
  }catch{}
}
['change','click'].forEach(ev=>{
  els.radius.addEventListener(ev, savePrefs);
  els.limit.addEventListener(ev, savePrefs);
  els.sort.addEventListener(ev, savePrefs);
  els.openNow.addEventListener(ev, ()=>{
    els.includeUnknown.disabled = !els.openNow.checked;
    if(!els.openNow.checked){ els.includeUnknown.checked = false; }
    savePrefs();
  });
  els.includeUnknown.addEventListener(ev, savePrefs);
});

// ---------- Chips (cat√©gories) ----------
els.cats.addEventListener('click', e=>{
  const c=e.target.closest('.chip'); if(!c) return;
  c.classList.toggle('active');
});

// ---------- Ajouter mot-cl√© libre ----------
els.btnAddKw.addEventListener('click', ()=>{
  const val = (els.freeKw.value||'').trim();
  if(!val) return;
  const chip = document.createElement('div');
  chip.className = 'chip active';
  chip.dataset.key = val;
  chip.textContent = val;
  els.cats.appendChild(chip);
  els.freeKw.value = '';
});

// ---------- G√©olocalisation ----------
els.btnGeo.addEventListener('click', async ()=>{
  if(!('geolocation' in navigator)){
    toast("G√©oloc indisponible sur ce navigateur.");
    return;
  }
  navigator.geolocation.getCurrentPosition(async pos=>{
    state.lat=pos.coords.latitude; state.lon=pos.coords.longitude;
    try{
      const r = await fetch(`${WORKER_URL}/geocode?lat=${state.lat}&lon=${state.lon}`);
      const j = await r.json();
      state.city = j.results?.[0]?.address_components?.find(c=>c.types.includes("locality"))?.long_name
                || j.results?.[0]?.formatted_address
                || "‚Äî";
      els.city.textContent = state.city;
      toast("Position enregistr√©e ‚úÖ");
    }catch{
      els.city.textContent = "‚Äî";
      toast("Position enregistr√©e ‚úÖ (reverse geocode indisponible)");
    }
  }, err=>{
    toast("Impossible d'obtenir la position (permission refus√©e ?)");
  }, {enableHighAccuracy:true, timeout:12000, maximumAge:0});
});

// ---------- Recherche ----------
els.btnSearch.addEventListener('click', async()=>{
  if(!(state.lat&&state.lon)){ toast("Clique d‚Äôabord sur Me g√©olocaliser."); return; }

  const radius = parseInt(els.radius.value,10);
  const limit  = parseInt(els.limit.value,10);
  const sort   = els.sort.value;
  const openNow = els.openNow.checked;
  const includeUnknown = els.includeUnknown.checked;

  const kws = [...document.querySelectorAll('.chip.active')].map(c=>c.dataset.key);
  if(kws.length===0){ toast("S√©lectionne au moins une cat√©gorie."); return; }

  setSearching(true);
  try{
    let all = [];
    for(const kw of kws){
      const params = new URLSearchParams({
        lat: String(state.lat),
        lon: String(state.lon),
        radius: String(radius),
        keyword: kw
      });
      if(openNow) params.set('opennow','1'); // envoy√© seulement si demand√©

      const r = await fetch(`${WORKER_URL}/nearby?${params.toString()}`);
      const j = await r.json();

      for(const p of (j.results||[])){
        const lat=p.geometry?.location?.lat, lon=p.geometry?.location?.lng;
        const status = p.opening_hours ? (p.opening_hours.open_now ? "open" : "closed") : "unknown";
        all.push({
          place_id:p.place_id,
          name:p.name,
          addr:p.vicinity||p.formatted_address||"",
          lat, lon, kw,
          dist: distKm(state.lat,state.lon,lat,lon),
          status
        });
      }
    }

    // ---- Filtre local "Ouverts maintenant" (fix) ----
    if(openNow){
      all = all.filter(r => r.status === 'open' || (includeUnknown && r.status === 'unknown'));
    }

    // D√©dup par place_id + fusion des cat√©gories + meilleure adresse
    const map = new Map();
    for(const row of all){
      const prev = map.get(row.place_id);
      if(!prev){
        map.set(row.place_id, {...row, cats:new Set([row.kw])});
      }else{
        prev.cats.add(row.kw);
        if((row.addr||'').length > (prev.addr||'').length){ prev.addr = row.addr; }
        if(row.status === 'open' || prev.status === 'open'){
          prev.status = 'open';
        }
      }
    }

    let rows = [...map.values()].map(r=>({ ...r, kw: [...r.cats].join(' ¬∑ ')}));

    // Tri global
    rows.sort((a,b)=> (sort==="name" ? a.name.localeCompare(b.name) : a.dist-b.dist));

    // Limite finale
    rows = rows.slice(0, limit);
    state.results = rows;

    if(!rows.length){ toast("Aucun r√©sultat trouv√©."); return; }

    els.results.innerHTML = rows.map((p,i)=>`
      <div class="item" data-name="${p.name}" data-addr="${p.addr}" data-cats="${p.kw}" data-dist="${p.dist.toFixed(2)}">
        <div><strong>${p.name}</strong></div>
        <div class="meta">
          <span>${p.status==="open"?"üü¢ Ouvert":p.status==="closed"?"üî¥ Ferm√©":"‚ö™ Horaires non renseign√©s"}</span>
          <span class="badge">${p.kw} ¬∑ ${p.dist.toFixed(1)} km</span>
          <span class="badge">${p.addr}</span>
        </div>
        <div class="row-slim">
          <a class="btn" target="_blank" href="https://www.google.com/maps/place/?q=place_id:${encodeURIComponent(p.place_id)}">‚û°Ô∏è Maps</a>
          <button class="btn" onclick="showDetails('${p.place_id}','det-${i}')">üìû Coordonn√©es</button>
        </div>
        <div class="badge" id="det-${i}" style="margin-top:6px;display:none"></div>
      </div>
    `).join("");

  }catch(e){
    console.warn(e);
    toast("Erreur (proxy/Google).");
  }finally{
    setSearching(false);
  }
});

// ---------- D√©tails (t√©l√©phone + site)
async function showDetails(placeId,detId){
  const el=document.getElementById(detId);
  if(el.style.display==="block"){ el.style.display="none"; return; }
  el.style.display="block"; el.textContent="Chargement‚Ä¶";
  try{
    const r=await fetch(`${WORKER_URL}/details?place_id=${encodeURIComponent(placeId)}`);
    const j=await r.json();
    const d=j.result||{};
    const tel=d.formatted_phone_number||d.international_phone_number||"‚Äî";
    const web=d.website?`<a target="_blank" href="${d.website}">${d.website}</a>`:"‚Äî";
    const telLink = tel && tel!=="‚Äî" ? `<a href="tel:${tel.replaceAll(' ','')}">${tel}</a>` : "‚Äî";
    el.innerHTML=`‚òéÔ∏è ${telLink} &nbsp; ‚Ä¢ &nbsp; üåê ${web}`;
  }catch{
    el.textContent="Impossible de r√©cup√©rer les coordonn√©es.";
  }
}

// ---------- Export CSV (r√©sultats visibles)
els.btnExport.addEventListener('click', ()=>{
  const rows = state.results||[];
  if(!rows.length){ toast("Rien √† exporter (lance une recherche)."); return; }
  const header = "Nom;Adresse;Cat√©gories;Distance (km);Latitude;Longitude;PlaceID\n";
  const body = rows.map(r=>[
    r.name.replace(/;/g,","), (r.addr||"").replace(/;/g,","), r.kw,
    r.dist.toFixed(2), r.lat, r.lon, r.place_id
  ].join(";")).join("\n");
  const blob = new Blob([header+body], {type:"text/csv;charset=utf-8"});
  const a = Object.assign(document.createElement("a"), {href: URL.createObjectURL(blob), download: "prospects.csv"});
  a.click(); URL.revokeObjectURL(a.href);
});

// ---------- R√©initialiser l‚Äôappli (cache + service worker)
els.btnResetApp.addEventListener('click', async ()=>{
  if(!confirm("Purger le cache, les donn√©es et le service worker ?")) return;
  try{
    if('caches' in window){
      const names = await caches.keys();
      await Promise.all(names.map(n => caches.delete(n)));
    }
    if('serviceWorker' in navigator){
      const regs = await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(r => r.unregister()));
    }
    localStorage.clear(); sessionStorage.clear();
    alert("OK. Recharge l‚Äôapp.");
    location.reload();
  }catch(e){
    alert("Impossible de purger : " + e.message);
  }
});

// Charger pr√©f√©rences au d√©marrage
loadPrefs();
</script>
</body>
</html>
